// ====================================================================
// GOOGLE SHEETS API - INTEGRA√á√ÉO COMPLETA (BASEADO NO ERP)
// ====================================================================

// Configura√ß√µes da API do Google
// IMPORTANTE: Configure as vari√°veis de ambiente no arquivo env-config.js
console.log('üîç Verificando vari√°veis de ambiente:', window.ENV);
const CLIENT_ID = window.ENV?.GOOGLE_CLIENT_ID || '';
const API_KEY = window.ENV?.GOOGLE_API_KEY || '';
const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
const SPREADSHEET_ID = window.ENV?.GOOGLE_SPREADSHEET_ID || '';

console.log('üîë Credenciais carregadas:', {
    CLIENT_ID: CLIENT_ID ? '‚úÖ Presente' : '‚ùå Ausente',
    API_KEY: API_KEY ? '‚úÖ Presente' : '‚ùå Ausente',
    SPREADSHEET_ID: SPREADSHEET_ID ? '‚úÖ Presente' : '‚ùå Ausente'
});

let tokenClient;
let gapiInited = false;
let gisInited = false;
let sheets = [];
let activeSheetName = '';

// ====================================================================
// INICIALIZA√á√ÉO DA API
// ====================================================================

// Carrega a biblioteca GAPI
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: [DISCOVERY_DOC],
    });
    gapiInited = true;
    console.log('‚úÖ Google API inicializada');
    // Tenta restaurar a sess√£o se o GIS tamb√©m j√° estiver pronto
    if (gisInited) await restoreSession();
}

// Carrega o Google Identity Services
async function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
            if (resp.error !== undefined) {
                throw (resp);
            }
            // Salva o token e a data de expira√ß√£o no localStorage
            const expiresIn = resp.expires_in;
            const tokenData = { 
                token: resp.access_token, 
                expiresAt: Date.now() + expiresIn * 1000 
            };
            localStorage.setItem('google_auth_token', JSON.stringify(tokenData));

            console.log('‚úÖ Autenticado com sucesso!');
            showToast('‚úÖ Conectado ao Google Sheets!', 'success');
            
            // Atualiza UI dos bot√µes
            updateAuthButtons(true);
            if (typeof updateERPAuthButtons === 'function') {
                updateERPAuthButtons(true);
            }
            
            // Carrega a planilha e suas abas
            await loadSpreadsheetAndSheets();
            
            // Carrega ERP se estiver na view ERP
            if (typeof loadERPSpreadsheet === 'function') {
                await loadERPSpreadsheet();
            }
        },
    });
    gisInited = true;
    console.log('‚úÖ Google Identity Services inicializado');
    // Tenta restaurar a sess√£o se o GAPI tamb√©m j√° estiver pronto
    if (gapiInited) await restoreSession();
}

// ====================================================================
// GERENCIAMENTO DE AUTENTICA√á√ÉO
// ====================================================================

function handleAuthClick() {
    // Verifica se as APIs est√£o inicializadas
    if (!gapiInited || !gisInited) {
        showToast('‚è≥ Aguarde, as APIs do Google ainda est√£o carregando...', 'warning');
        console.warn('APIs n√£o inicializadas. gapiInited:', gapiInited, 'gisInited:', gisInited);
        return;
    }
    
    if (!tokenClient) {
        showToast('‚ùå Erro: tokenClient n√£o inicializado', 'error');
        console.error('tokenClient est√° undefined');
        return;
    }
    
    // Solicita o token de acesso
    tokenClient.requestAccessToken({prompt: 'consent'});
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken('');
            localStorage.removeItem('google_auth_token');
            window.sessionRestored = false;
            
            showToast('Desconectado do Google Sheets', 'info');
            console.log('‚úÖ Desconectado');
            
            // Atualiza UI dos bot√µes
            updateAuthButtons(false);
            if (typeof updateERPAuthButtons === 'function') {
                updateERPAuthButtons(false);
            }
            
            // Limpa os dados
            if (typeof erpData !== 'undefined') {
                erpData.items = [];
                erpData.categories = [];
                erpData.hours = [];
                erpData.neighborhoods = [];
                
                // Limpa as tabelas
                if (typeof renderItemsTable === 'function') renderItemsTable();
                if (typeof renderCategoriesGrid === 'function') renderCategoriesGrid();
                if (typeof renderHoursTable === 'function') renderHoursTable();
                if (typeof renderNeighborhoodsTable === 'function') renderNeighborhoodsTable();
            }
        });
    }
}

// Fun√ß√£o para restaurar a sess√£o do usu√°rio
async function restoreSession() {
    // Garante que a fun√ß√£o s√≥ execute uma vez
    if (window.sessionRestored) return;

    const tokenDataString = localStorage.getItem('google_auth_token');
    if (!tokenDataString) {
        window.sessionRestored = true;
        return; // Nenhum token salvo
    }

    const tokenData = JSON.parse(tokenDataString);

    // Verifica se o token expirou
    if (Date.now() >= tokenData.expiresAt) {
        window.sessionRestored = true;
        localStorage.removeItem('google_auth_token');
        console.log('‚ö†Ô∏è Token expirado, fa√ßa login novamente');
        return;
    }

    // Se o token for v√°lido, configura o GAPI
    window.sessionRestored = true;
    gapi.client.setToken({ access_token: tokenData.token });
    
    console.log('‚úÖ Sess√£o restaurada! Carregando dados...');
    showToast('‚úÖ Sess√£o restaurada! Carregando dados...', 'info', 2000);
    
    // Atualiza UI dos bot√µes
    updateAuthButtons(true);
    if (typeof updateERPAuthButtons === 'function') {
        updateERPAuthButtons(true);
    }
    
    // Carrega a planilha e suas abas
    await loadSpreadsheetAndSheets();
    
    // Carrega ERP se estiver na view ERP
    if (typeof loadERPSpreadsheet === 'function') {
        await loadERPSpreadsheet();
    }
}

// Atualiza a visibilidade dos bot√µes de autentica√ß√£o
function updateAuthButtons(isConnected) {
    const connectBtn = document.getElementById('connect-google-btn');
    const disconnectBtn = document.getElementById('disconnect-google-btn');
    
    if (connectBtn && disconnectBtn) {
        if (isConnected) {
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'inline-flex';
        } else {
            connectBtn.style.display = 'inline-flex';
            disconnectBtn.style.display = 'none';
        }
    }
}

// ====================================================================
// CARREGAMENTO DA PLANILHA E ABAS
// ====================================================================

// Carrega a planilha e suas abas
async function loadSpreadsheetAndSheets() {
    try {
        console.log('üîÑ Carregando planilha e abas...');
        showToast('Carregando planilha...', 'info', 2000);
        
        const response = await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: SPREADSHEET_ID,
        });
        
        sheets = response.result.sheets;
        
        if (!sheets || sheets.length === 0) {
            showToast('Nenhuma aba encontrada nesta planilha.', 'error');
            return;
        }
        
        console.log('‚úÖ Planilha carregada!', sheets.length, 'abas encontradas');
        console.log('üìã Abas:', sheets.map(s => s.properties.title));
        
        // Carrega dados de todas as abas automaticamente
        await loadAllSheets();
        
        showToast('‚úÖ Todas as abas carregadas com sucesso!', 'success');
        
    } catch (err) {
        console.error('‚ùå Erro ao carregar a planilha:', err);
        showToast('Erro ao carregar planilha: ' + (err.result?.error?.message || err.message), 'error');
    }
}

// Carrega dados de todas as abas
async function loadAllSheets() {
    try {
        console.log('üîÑ Carregando dados de todas as abas...');
        
        // Mapeia os nomes das abas para as fun√ß√µes de carregamento
        const sheetLoaders = {
            'Itens': loadItemsFromSheet,
            'itens': loadItemsFromSheet,
            'Categorias': loadCategoriesFromSheet,
            'categorias': loadCategoriesFromSheet,
            'Hor√°rios': loadHoursFromSheet,
            'horarios': loadHoursFromSheet,
            'Horarios': loadHoursFromSheet,
            'Bairros': loadNeighborhoodsFromSheet,
            'bairros': loadNeighborhoodsFromSheet
        };
        
        // Carrega cada aba encontrada
        const loadPromises = sheets.map(async (sheet) => {
            const sheetName = sheet.properties.title;
            const loader = sheetLoaders[sheetName];
            
            if (loader) {
                console.log(`üìÑ Carregando aba: ${sheetName}`);
                await loader(sheetName);
            } else {
                console.log(`‚ö†Ô∏è Aba ignorada: ${sheetName}`);
            }
        });
        
        await Promise.all(loadPromises);
        
        console.log('‚úÖ Todas as abas foram carregadas!');
        
    } catch (err) {
        console.error('‚ùå Erro ao carregar abas:', err);
        showToast('Erro ao carregar dados: ' + err.message, 'error');
    }
}

// ====================================================================
// CARREGAMENTO DE DADOS POR ABA
// ====================================================================

// Carrega dados da aba Itens
async function loadItemsFromSheet(sheetName) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${sheetName}'!A:Z`,
        });

        const rows = response.result.values;
        if (!rows || rows.length === 0) {
            console.log('‚ö†Ô∏è Nenhum dado encontrado na aba Itens.');
            return;
        }

        const headers = rows[0];
        console.log('üìã Headers Itens:', headers);

        // Mapear dados
        erpData.items = rows.slice(1).map((row, index) => {
            const item = {
                id: row[0] || index + 1,
                name: row[1] || '',
                category: row[2] || '',
                description: row[3] || '',
                price: row[4] || '',
                status: row[5] || 'ativo',
                image: ''
            };
            
            // Valida se √© uma URL v√°lida antes de usar como imagem
            if (row[7] && (row[7].startsWith('http://') || row[7].startsWith('https://'))) {
                item.image = row[7];
            }
            
            return item;
        });

        console.log('‚úÖ Itens carregados:', erpData.items.length);
        if (typeof renderItemsTable === 'function') renderItemsTable();
        if (typeof loadCategoryFilter === 'function') loadCategoryFilter();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar itens:', error);
        throw error;
    }
}

// Carrega dados da aba Categorias
async function loadCategoriesFromSheet(sheetName) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${sheetName}'!A:Z`,
        });

        const rows = response.result.values;
        if (!rows || rows.length === 0) {
            console.log('‚ö†Ô∏è Nenhum dado encontrado na aba Categorias.');
            return;
        }

        const headers = rows[0];
        console.log('üìã Headers Categorias:', headers);

        erpData.categories = rows.slice(1).map((row, index) => ({
            id: index + 1,
            name: row[0] || '',
            icon: row[1] || 'üçï',
            description: row[2] || '',
            order: parseInt(row[3]) || index + 1,
            status: row[4] || 'ativo'
        }));

        console.log('‚úÖ Categorias carregadas:', erpData.categories.length);
        if (typeof renderCategoriesGrid === 'function') renderCategoriesGrid();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar categorias:', error);
        throw error;
    }
}

// Carrega dados da aba Hor√°rios
async function loadHoursFromSheet(sheetName) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${sheetName}'!A:Z`,
        });

        const rows = response.result.values;
        if (!rows || rows.length === 0) {
            console.log('‚ö†Ô∏è Nenhum dado encontrado na aba Hor√°rios.');
            return;
        }

        const headers = rows[0];
        console.log('üìã Headers Hor√°rios:', headers);

        erpData.hours = rows.slice(1).map((row, index) => {
            const periodo1 = row[1] || '';
            const [open, close] = periodo1.split(' - ');
            
            return {
                id: index + 1,
                day: row[0] || '',
                open: open || '',
                close: close || '',
                status: 'open'
            };
        });

        console.log('‚úÖ Hor√°rios carregados:', erpData.hours.length);
        if (typeof renderHoursTable === 'function') renderHoursTable();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar hor√°rios:', error);
        throw error;
    }
}

// Carrega dados da aba Bairros
async function loadNeighborhoodsFromSheet(sheetName) {
    try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${sheetName}'!A:Z`,
        });

        const rows = response.result.values;
        if (!rows || rows.length === 0) {
            console.log('‚ö†Ô∏è Nenhum dado encontrado na aba Bairros.');
            return;
        }

        const headers = rows[0];
        console.log('üìã Headers Bairros:', headers);

        erpData.neighborhoods = rows.slice(1).map((row, index) => ({
            id: index + 1,
            name: row[0] || '',
            fee: row[1] || '0',
            time: '30-40 min',
            status: 'active'
        }));

        console.log('‚úÖ Bairros carregados:', erpData.neighborhoods.length);
        if (typeof renderNeighborhoodsTable === 'function') renderNeighborhoodsTable();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar bairros:', error);
        throw error;
    }
}

// ====================================================================
// FUN√á√ÉO DE RECARGA MANUAL
// ====================================================================

async function loadAllDataFromSheets() {
    // Verifica se as APIs est√£o inicializadas
    if (!gapiInited || !gisInited) {
        showToast('‚è≥ Aguarde, as APIs do Google ainda est√£o carregando...', 'warning');
        console.warn('APIs n√£o inicializadas. gapiInited:', gapiInited, 'gisInited:', gisInited);
        return;
    }
    
    // Verifica se est√° autenticado
    if (!gapi || !gapi.client || !gapi.client.getToken()) {
        showToast('‚ö†Ô∏è Fa√ßa login primeiro!', 'warning');
        return;
    }
    
    await loadSpreadsheetAndSheets();
}

// Expor fun√ß√µes globalmente para serem chamadas pelos scripts do Google
window.gapiLoaded = gapiLoaded;
window.gisLoaded = gisLoaded;

// ====================================================================
// FUN√á√ïES DE ESCRITA NA PLANILHA
// ====================================================================

// Atualizar um item na planilha
async function updateItemInSheet(item) {
    try {
        console.log('üìù Atualizando item na planilha:', item);
        
        // Encontrar a linha do item (linha 1 √© header, ent√£o item.id + 1)
        const rowIndex = parseInt(item.id) + 1;
        
        const values = [[
            item.id,
            item.name,
            item.category,
            item.description,
            item.price,
            item.status,
            '', // adicionais_obrigatorios
            item.image
        ]];
        
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `Itens!A${rowIndex}:H${rowIndex}`,
            valueInputOption: 'USER_ENTERED',
            resource: { values }
        });
        
        console.log('‚úÖ Item atualizado na planilha');
        showToast('Item atualizado na planilha!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao atualizar item:', error);
        showToast('Erro ao atualizar item: ' + error.message, 'error');
        throw error;
    }
}

// Adicionar novo item na planilha
async function addItemToSheet(item) {
    try {
        console.log('‚ûï Adicionando item na planilha:', item);
        
        const values = [[
            item.id,
            item.name,
            item.category,
            item.description,
            item.price,
            item.status,
            '', // adicionais_obrigatorios
            item.image
        ]];
        
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: 'Itens!A:H',
            valueInputOption: 'USER_ENTERED',
            resource: { values }
        });
        
        console.log('‚úÖ Item adicionado na planilha');
        showToast('Item adicionado na planilha!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao adicionar item:', error);
        showToast('Erro ao adicionar item: ' + error.message, 'error');
        throw error;
    }
}

// Deletar item da planilha
async function deleteItemFromSheet(itemId) {
    try {
        console.log('üóëÔ∏è Deletando item da planilha:', itemId);
        
        // Encontrar a linha do item
        const rowIndex = parseInt(itemId);
        
        // Buscar o sheetId da aba Itens
        const response = await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: SPREADSHEET_ID,
        });
        
        const sheet = response.result.sheets.find(s => s.properties.title === 'Itens');
        if (!sheet) throw new Error('Aba Itens n√£o encontrada');
        
        const sheetId = sheet.properties.sheetId;
        
        // Deletar a linha
        await gapi.client.sheets.spreadsheets.batchUpdate({
            spreadsheetId: SPREADSHEET_ID,
            resource: {
                requests: [{
                    deleteDimension: {
                        range: {
                            sheetId: sheetId,
                            dimension: 'ROWS',
                            startIndex: rowIndex, // 0-indexed
                            endIndex: rowIndex + 1
                        }
                    }
                }]
            }
        });
        
        console.log('‚úÖ Item deletado da planilha');
        showToast('Item deletado da planilha!', 'success');
        
    } catch (error) {
        console.error('‚ùå Erro ao deletar item:', error);
        showToast('Erro ao deletar item: ' + error.message, 'error');
        throw error;
    }
}

// Expor fun√ß√µes globalmente
window.updateItemInSheet = updateItemInSheet;
window.addItemToSheet = addItemToSheet;
window.deleteItemFromSheet = deleteItemFromSheet;

// Chamar quando a p√°gina carregar
window.addEventListener('load', () => {
    console.log('üöÄ Sistema ERP carregado');
    console.log('‚è≥ Aguardando inicializa√ß√£o das APIs do Google...');
});
