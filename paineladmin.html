<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="origin-trial" content="">
    <title>Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Carregar erp-integration.js ANTES para expor gapiLoaded e gisLoaded -->
    <script src="erp-integration.js"></script>
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
    <script>
        // Inicialização do Supabase
     const SUPABASE_URL = 'https://pqoafjslbvfhwbvepuox.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxb2FmanNsYnZmaHdidmVwdW94Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTY5MTYsImV4cCI6MjA3NjAzMjkxNn0.oGIuSfm1BFIB1X079Bb4uz4Pz8z_todLeveO_6AZsHc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variável global para armazenar a referência da janela do WhatsApp
        let whatsappWindow = null;
        
        // Proteção de Rota com Supabase
        (async () => {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                // Tratar erro de token inválido
                if (error) {
                    if (error.message && (error.message.includes('refresh') || error.message.includes('token'))) {
                        console.warn('⚠️ Token inválido detectado, redirecionando para login...');
                        await supabase.auth.signOut();
                        localStorage.clear();
                    }
                    window.location.href = 'login.html';
                    return;
                }
                
                if (!session) {
                    window.location.href = 'login.html';
                }
            } catch (err) {
                console.error('Erro ao verificar sessão:', err);
                window.location.href = 'login.html';
            }
        })();
        
        // Capturar erros de refresh token globalmente
        window.addEventListener('unhandledrejection', (event) => {
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Invalid Refresh Token') || 
                 event.reason.message.includes('Refresh Token Not Found'))) {
                console.warn('⚠️ Erro de refresh token detectado, redirecionando...');
                event.preventDefault();
                
                supabase.auth.signOut().then(() => {
                    localStorage.clear();
                    window.location.href = 'login.html';
                });
            }
        });
    </script>
    <!-- Biblioteca de Gráficos (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .order-card {
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
        }
        :root {
            /* Cores são carregadas dinamicamente via JS, estes são os fallbacks */
            --cor-primaria: #D92B2B;
            --cor-secundaria: #FFC700;
            --cor-terciaria: #FDB813;
            --cor-fundo: #F9F9F9;
            --cor-texto: #212121;
            --cor-sucesso: #28a745;
            --cor-sucesso-fundo: #E8F5E9;
            --cor-erro: #dc3545;
            --cor-erro-fundo: #FFEBEE;
            --cor-aviso: #FFC700;
            --cor-aviso-fundo: #FFF8E1;
            --cor-borda: #E5E7EB;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--cor-fundo); 
        }
        .sidebar-btn.active {
            background-color: var(--cor-primaria);
            color: white;
        }
        .sidebar-btn.active svg {
            color: white;
        }
        .sidebar-btn:not(.active):hover {
            background-color: var(--cor-borda);
        }
        .filter-btn.active {
            background-color: var(--cor-primaria);
            color: white;
            border-color: var(--cor-primaria);
        }
        .finance-filter-btn.active {
            background-color: var(--cor-primaria);
            color: white;
            border-color: var(--cor-primaria);
        }
        .order-card.new-order {
            animation: newOrderPulse 1.5s infinite;
            border-color: var(--cor-sucesso) !important;
        }
        @keyframes newOrderPulse {
            0% { box-shadow: 0 0 0 0 rgba(var(--cor-sucesso-rgb), 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(var(--cor-sucesso-rgb), 0); }
            100% { box-shadow: 0 0 0 0 rgba(var(--cor-sucesso-rgb), 0); }
        }
        .overdue-order {
            background-color: var(--cor-erro-fundo);
            border-color: var(--cor-erro) !important;
            animation: overduePulse 1.5s infinite;
        }
        @keyframes overduePulse {
            0% { box-shadow: 0 0 0 0 rgba(var(--cor-erro-rgb), 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(var(--cor-erro-rgb), 0); }
            100% { box-shadow: 0 0 0 0 rgba(var(--cor-erro-rgb), 0); }
        }
        .order-card {
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-out;
        }
        .order-card.new-order {
            animation: newOrderPulse 1.5s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-family: 'Courier New', monospace;
                page-break-after: avoid;
                page-break-inside: avoid;
            }
            /* Evitar página em branco */
            html, body {
                height: auto;
                overflow: hidden;
            }
            @page {
                size: auto;
                margin: 10mm;
            }
        }
        .status-btn {
            transition: all 0.2s ease;
        }
        .status-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Kanban styles */
        .kanban-column {            
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
            .kanban-column {
                height: calc(100vh - 150px); /* Altura ajustada para desktop */
            }
        }
        .kanban-cards {
            flex-grow: 1;
            overflow-y: auto;
            padding: 4px; /* Small padding for scrollbar */
        }
        .order-card.moving {
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        /* Drag and Drop styles */
        .order-card {
            cursor: grab;
        }
        .order-card.not-draggable {
            cursor: default;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c7d2fe;
        }
        /* Custom scrollbar */
        .kanban-cards::-webkit-scrollbar {
            width: 6px;
        }
        .kanban-cards::-webkit-scrollbar-track {
            background: transparent;
        }
        .kanban-cards::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 20px;
        }
        .kanban-cards::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
        /* Estilos para os botões de filtro */
        .filter-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db;
        }        
        
        .filter-btn:not(.active):hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        .finance-filter-btn {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 9999px;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
        }
        /* Estilos para modo tela cheia */
        body.fullscreen-mode #sidebar,
        body.fullscreen-mode header {
            display: none;
        }
        body.fullscreen-mode #main-content {
            height: 100vh;
            padding: 0;
        }
        body.fullscreen-mode #kanban-board {
            padding: 1rem; /* Adiciona um pequeno preenchimento nas bordas */
        }
        body.fullscreen-mode .kanban-column {
            height: calc(100vh - 2rem); /* Ajusta a altura das colunas para preencher a tela */
        }
        
        /* Animações suaves para contadores */
        [id^="count-"] {
            transition: transform 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: inline-block;
        }
        
        /* Melhoria nas animações dos cards */
        .order-card {
            will-change: transform, opacity;
        }
        
        .order-card.updating {
            animation: cardUpdate 0.5s ease;
        }
        
        @keyframes cardUpdate {
            0% { background-color: white; }
            50% { background-color: #fef3c7; }
            100% { background-color: white; }
        }
        
        /* Sistema de colapso de cards */
        .kanban-cards[data-collapsed="true"] .order-card:nth-child(n+4) {
            display: none !important;
        }
        
        .toggle-column-btn {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-column-btn:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para notificações (Toast) */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.21, 1.02, 0.73, 1);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .toast-notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .toast-notification.error {
            background-color: var(--cor-erro);
            color: white;
        }
        .toast-notification.warning {
            background-color: var(--cor-aviso);
            color: var(--cor-texto);
        }
        .toast-notification.success {
            background-color: var(--cor-sucesso);
            color: white;
        }
        .toast-notification-icon {
            flex-shrink: 0;
            font-size: 1.5rem;
            line-height: 1;
        }
        .toast-notification-content {
            flex-grow: 1;
        }
        .toast-notification-close {
            background: none;
            border: none;
            color: inherit;
            opacity: 0.7;
            cursor: pointer;
            font-size: 1.25rem;
        }
        .toast-notification-close:hover {
            opacity: 1;
        }
        /* Melhorias de Responsividade */
        @media (max-width: 640px) {
            .kanban-column {
                min-height: 300px; /* Garante uma altura mínima para colunas vazias em telas pequenas */
            }
        }

        /* Loading Overlay para Logout */
        .logout-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .logout-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .logout-content {
            text-align: center;
            color: white;
        }
        .logout-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .logout-text {
            font-size: 18px;
            font-weight: 600;
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

    </style>
</head>
<body class="flex h-screen bg-gray-100">

    <!-- Loading Overlay para Logout -->
    <div id="logout-overlay" class="logout-overlay">
        <div class="logout-content">
            <div class="logout-spinner"></div>
            <div class="logout-text">Saindo do sistema...</div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white shadow-md flex flex-col z-20 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
        <div class="p-4 border-b">
            <h2 class="text-xl font-bold text-gray-800">Gestão</h2>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <div class="mb-2">
                <p class="text-xs font-semibold text-gray-500 uppercase px-4 mb-2">Operacional</p>
                <a href="#" onclick="showView('kanban-view')" class="sidebar-btn active flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                    <span class="font-medium">Painel de Pedidos</span>
                </a>
                <a href="#" onclick="showView('finance-view')" class="sidebar-btn flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="font-medium">Financeiro</span>
                </a>
            </div>
            
            <div class="mb-2 pt-2 border-t border-gray-200">
                <p class="text-xs font-semibold text-gray-500 uppercase px-4 mb-2">Gerenciamento ERP</p>
                <a href="#" onclick="showView('erp-view')" class="sidebar-btn flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
                    <span class="font-medium">📊 Google Sheets ERP</span>
                </a>
            </div>
            
            <div class="pt-2 border-t border-gray-200">
                <a href="#" onclick="logout()" class="sidebar-btn flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="font-medium">Sair</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="flex-1 flex flex-col overflow-hidden transition-all duration-300 ease-in-out">
        <!-- Header -->
        <header class="bg-white shadow-sm z-10">
            <div class="container mx-auto p-4 flex flex-wrap justify-between items-center gap-4">
                <!-- Botão Menu para Mobile -->
                <button id="menu-toggle" class="md:hidden text-gray-600 hover:text-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>

                <div class="flex items-center space-x-2 sm:space-x-4">
                    <h1 id="view-title" class="text-2xl font-bold text-gray-800">Painel de Pedidos</h1>
                </div>

                <div class="flex items-center space-x-2 sm:space-x-4 ml-auto">
                    <!-- Campo de Busca -->
                    <div id="search-container" class="relative w-36 sm:w-48 md:w-64">
                        <input type="search" id="search-orders" placeholder="Buscar pedido..." class="w-full pl-10 pr-4 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-[color:var(--cor-primaria)] focus:border-transparent" oninput="handleSearch()">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                    <!-- Botão Tela Cheia -->
                    <button id="fullscreen-toggle" onclick="toggleFullScreen()" class="text-gray-500 hover:text-[color:var(--cor-primaria)] transition-colors" title="Modo Tela Cheia">
                        <svg id="fullscreen-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 1v-4m0 0h-4m4 0l-5 5"></path></svg>
                        <svg id="fullscreen-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l-5 5m0 0h4v-4m-4 4V10m14 4l5 5m0 0h-4v-4m4 4V10M10 10l-5-5m0 0h4v4m-4-4V14m14-4l5-5m0 0h-4v4m4-4V14"></path></svg>
                    </button>
                    <label for="sound-toggle" class="text-sm mr-4">Som:</label>
                    <input type="checkbox" id="sound-toggle" checked>
                    <span id="status-indicator" class="text-sm font-medium ml-4"></span>
                </div>
            </div>
            <!-- Filtros de Pedido (agora abaixo do header principal) -->
            <div id="order-filters" class="container mx-auto px-4 pb-4 flex items-center space-x-2">
                <button data-filter="all" class="filter-btn active text-sm px-3 py-1.5 rounded-full bg-white text-gray-700 font-medium">Todos</button>
                <button data-filter="delivery" class="filter-btn text-sm px-3 py-1.5 rounded-full bg-white text-gray-700 font-medium">🛵 Delivery</button>
                <button data-filter="pickup" class="filter-btn text-sm px-3 py-1.5 rounded-full bg-white text-gray-700 font-medium">🥡 Retirada</button>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 p-4 overflow-auto">
            <!-- Kanban View -->
            <div id="kanban-view" class="view-container">
                <!-- Kanban Board -->
                <div id="kanban-board" class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 md:overflow-x-auto pb-4">
                    <!-- Coluna Novos -->
                    <div class="kanban-column bg-gray-100 rounded-lg p-3 w-full md:w-80 lg:w-96 flex-shrink-0">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full" style="background-color: var(--cor-sucesso);"></span>
                                <h2 class="font-bold text-lg text-gray-800">Novos Pedidos</h2>
                            </div>
                            <span id="count-novo" class="text-sm font-bold px-2.5 py-1 rounded-full" style="background-color: var(--cor-sucesso-fundo); color: var(--cor-sucesso);">0</span>
                        </div>
                        <div id="column-novo" class="kanban-cards space-y-3 min-h-[200px]" data-collapsed="false"></div>
                        <button id="toggle-novo" class="toggle-column-btn hidden mt-3 w-full py-2 px-3 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 transition-colors" onclick="toggleColumn('novo')">
                            <span class="expand-text">▼ Ver mais</span>
                            <span class="collapse-text hidden">▲ Ver menos</span>
                        </button>
                    </div>

                    <!-- Coluna Em Preparo -->
                    <div class="kanban-column bg-gray-100 rounded-lg p-3 w-full md:w-80 lg:w-96 flex-shrink-0">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full" style="background-color: var(--cor-aviso);"></span>
                                <h2 class="font-bold text-lg text-gray-800">Em Preparo</h2>
                            </div>
                            <span id="count-em-preparo" class="text-sm font-bold px-2.5 py-1 rounded-full" style="background-color: var(--cor-aviso-fundo); color: var(--cor-aviso);">0</span>
                        </div>
                        <div id="column-em-preparo" class="kanban-cards space-y-3 min-h-[200px]" data-collapsed="false"></div>
                        <button id="toggle-em-preparo" class="toggle-column-btn hidden mt-3 w-full py-2 px-3 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 transition-colors" onclick="toggleColumn('em-preparo')">
                            <span class="expand-text">▼ Ver mais</span>
                            <span class="collapse-text hidden">▲ Ver menos</span>
                        </button>
                    </div>

                    <!-- Coluna Finalizados -->
                    <div class="kanban-column bg-gray-100 rounded-lg p-3 w-full md:w-80 lg:w-96 flex-shrink-0">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 bg-gray-500 rounded-full"></span>
                                <h2 class="font-bold text-lg text-gray-800">Finalizados</h2>
                            </div>
                            <span id="count-finalizado" class="bg-gray-200 text-gray-800 text-sm font-bold px-2.5 py-1 rounded-full">0</span>
                        </div>
                        <div id="column-finalizado" class="kanban-cards space-y-3 min-h-[200px]" data-collapsed="false"></div>
                        <button id="toggle-finalizado" class="toggle-column-btn hidden mt-3 w-full py-2 px-3 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 transition-colors" onclick="toggleColumn('finalizado')">
                            <span class="expand-text">▼ Ver mais</span>
                            <span class="collapse-text hidden">▲ Ver menos</span>
                        </button>
                    </div>

                    <!-- Coluna Cancelados -->
                    <div class="kanban-column rounded-lg p-3 w-full md:w-80 lg:w-96 flex-shrink-0" style="background-color: var(--cor-erro-fundo);">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <div class="flex items-center space-x-2">
                                <span class="w-2 h-2 rounded-full" style="background-color: var(--cor-erro);"></span>
                                <h2 class="font-bold text-lg" style="color: var(--cor-erro);">Cancelados</h2>
                            </div>
                            <span id="count-cancelado" class="text-sm font-bold px-2.5 py-1 rounded-full" style="background-color: var(--cor-erro-fundo); color: var(--cor-erro);">0</span>
                        </div>
                        <div id="column-cancelado" class="kanban-cards space-y-3 min-h-[200px]" data-collapsed="false"></div>
                        <button id="toggle-cancelado" class="toggle-column-btn hidden mt-3 w-full py-2 px-3 bg-white hover:bg-gray-50 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 transition-colors" onclick="toggleColumn('cancelado')">
                            <span class="expand-text">▼ Ver mais</span>
                            <span class="collapse-text hidden">▲ Ver menos</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Finance View -->
            <div id="finance-view" class="view-container hidden">
                <!-- Filtros de Data -->
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <!-- Título e Info -->
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                            Filtros de Período
                        </h3>
                        <span id="period-info" class="text-sm text-gray-500 font-medium"></span>
                    </div>
                    
                    <!-- Filtros Rápidos -->
                    <div class="mb-4">
                        <label class="text-sm font-medium text-gray-700 mb-2 block">Períodos Rápidos:</label>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterSales('today')" data-period="today" class="finance-filter-btn active">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Hoje
                            </button>
                            <button onclick="filterSales('yesterday')" data-period="yesterday" class="finance-filter-btn">Ontem</button>
                            <button onclick="filterSales('last7days')" data-period="last7days" class="finance-filter-btn">Últimos 7 dias</button>
                            <button onclick="filterSales('last30days')" data-period="last30days" class="finance-filter-btn">Últimos 30 dias</button>
                            <button onclick="filterSales('this_week')" data-period="this_week" class="finance-filter-btn">Esta Semana</button>
                            <button onclick="filterSales('last_week')" data-period="last_week" class="finance-filter-btn">Semana Passada</button>
                            <button onclick="filterSales('this_month')" data-period="this_month" class="finance-filter-btn">Este Mês</button>
                            <button onclick="filterSales('last_month')" data-period="last_month" class="finance-filter-btn">Mês Passado</button>
                            <button onclick="filterSales('this_year')" data-period="this_year" class="finance-filter-btn">Este Ano</button>
                        </div>
                    </div>
                    
                    <!-- Filtro Personalizado -->
                    <div class="border-t pt-4">
                        <label class="text-sm font-medium text-gray-700 mb-2 block">Período Personalizado:</label>
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                            <div class="flex-1 flex items-center gap-2">
                                <label for="start-date" class="text-sm text-gray-600 whitespace-nowrap">De:</label>
                                <input type="date" id="start-date" class="finance-filter-btn flex-1" onchange="deactivatePresetButtons()">
                            </div>
                            <div class="flex-1 flex items-center gap-2">
                                <label for="end-date" class="text-sm text-gray-600 whitespace-nowrap">Até:</label>
                                <input type="date" id="end-date" class="finance-filter-btn flex-1" onchange="deactivatePresetButtons()">
                            </div>
                            <div class="flex gap-2">
                                <button onclick="filterSales('custom')" data-period="custom" class="finance-filter-btn bg-blue-600 text-white border-blue-600 hover:bg-blue-700 px-6">
                                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    Buscar
                                </button>
                                <button onclick="clearDateFilters()" class="finance-filter-btn bg-gray-500 text-white border-gray-500 hover:bg-gray-600" title="Limpar filtros">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                                <button onclick="exportFinanceToCSV()" id="export-csv-btn" class="finance-filter-btn bg-green-600 text-white border-green-600 hover:bg-green-700 flex items-center gap-2" title="Exportar dados para CSV">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    <span class="hidden sm:inline">Exportar</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard de Vendas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Card Vendas no Período -->
                    <div class="relative bg-gradient-to-br from-green-500 to-teal-600 text-white p-6 rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full"></div>
                        <div class="relative z-10">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white/20 p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg></div>
                                <h3 id="sales-period-label" class="text-base font-medium opacity-90">Vendas</h3>
                            </div>
                            <p id="sales-period-total" class="mt-2 text-4xl font-bold tracking-tight">R$ 0,00</p>
                        </div>
                    </div>
                    <!-- Card Pedidos no Período -->
                    <div class="relative bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full"></div>
                        <div class="relative z-10">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white/20 p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>
                                <h3 id="orders-period-label" class="text-base font-medium opacity-90">Pedidos</h3>
                            </div>
                            <p id="orders-period-count" class="mt-2 text-4xl font-bold tracking-tight">0</p>
                        </div>
                    </div>
                    <!-- Card Ticket Médio -->
                    <div class="relative bg-gradient-to-br from-purple-500 to-pink-600 text-white p-6 rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full"></div>
                        <div class="relative z-10">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white/20 p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg></div>
                                <h3 class="text-base font-medium opacity-90">Ticket Médio</h3>
                            </div>
                            <p id="average-ticket" class="mt-2 text-4xl font-bold tracking-tight">R$ 0,00</p>
                        </div>
                    </div>
                    <!-- Card Clientes Únicos -->
                    <div class="relative bg-gradient-to-br from-orange-500 to-red-600 text-white p-6 rounded-xl shadow-lg overflow-hidden transition-all duration-300 hover:shadow-2xl hover:-translate-y-1">
                        <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white/10 rounded-full"></div>
                        <div class="relative z-10">
                            <div class="flex items-center space-x-3">
                                <div class="bg-white/20 p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></div>
                                <h3 class="text-base font-medium opacity-90">Clientes</h3>
                            </div>
                            <p id="unique-customers" class="mt-2 text-4xl font-bold tracking-tight">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Seção CRM - Análise de Clientes -->
                <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            Análise de Clientes (CRM)
                        </h3>
                        <button onclick="exportCustomersToCSV()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Exportar Clientes
                        </button>
                    </div>
                    
                    <!-- Tabela de Top Clientes -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ranking</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefone</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pedidos</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Gasto</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket Médio</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Pedido</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="crm-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Linhas serão inseridas dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Grid para Gráfico e Tabela -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mt-8">
                    <!-- Coluna do Gráfico -->
                    <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Receita por Pagamento</h3>
                        <div class="h-80 flex items-center justify-center">
                            <canvas id="payment-chart"></canvas>
                        </div>
                    </div>

                    <!-- Coluna da Tabela -->
                    <div class="lg:col-span-3 bg-white p-4 sm:p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Detalhes dos Pedidos</h3>
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pedido</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pagamento</th>
                                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                    </tr>
                                </thead>
                                <tbody id="finance-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Linhas serão inseridas dinamicamente -->
                                </tbody>
                                <tfoot class="bg-gray-100 border-t-2 border-gray-300 font-bold">
                                    <tr>
                                        <td colspan="2" class="px-4 py-4 text-right text-sm text-gray-800">Total de Pedidos:</td>
                                        <td id="finance-total-orders" class="px-4 py-4 text-left text-sm text-blue-700 font-bold">0</td>
                                        <td class="px-4 py-4 text-right text-sm text-gray-800">Valor Total:</td>
                                        <td id="finance-total-value" class="px-4 py-4 text-left text-sm text-green-700">R$ 0,00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ERP: Unified View with Tabs -->
            <div id="erp-view" class="view-container hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <!-- Header com botões de ação -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">📊 Sistema Google Sheets</h3>
                        <div class="flex gap-2">
                            <button onclick="handleAuthClick()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2" id="erp-connect-btn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Conectar com Google
                            </button>
                            <button onclick="handleSignoutClick()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2" id="erp-disconnect-btn" style="display:none;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                Desconectar
                            </button>
                        </div>
                    </div>

                    <!-- Controles -->
                    <div id="erp-controls" class="mb-6 flex gap-3" style="display:none;">
                        <button onclick="showERPAddModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            ➕ Adicionar Linha
                        </button>
                        <button onclick="loadERPSheetData()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                            🔄 Atualizar Dados
                        </button>
                        <input type="text" id="erp-search" placeholder="🔍 Buscar na tabela..." class="flex-1 px-4 py-2 border rounded-lg" oninput="filterERPTable()">
                        <div class="flex items-center gap-2">
                            <span id="erp-status-dot" class="w-3 h-3 rounded-full bg-gray-400"></span>
                            <span id="erp-status-text" class="text-sm text-gray-600">Desconectado</span>
                        </div>
                    </div>

                    <!-- Abas da Planilha -->
                    <div id="erp-sheets-nav" class="mb-6" style="display:none;">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Abas da Planilha</h4>
                        <div id="erp-sheets-tabs" class="flex flex-wrap gap-2">
                            <!-- Tabs serão inseridas aqui via JS -->
                        </div>
                    </div>

                    <!-- Tabela de Dados -->
                    <div id="erp-data-section" class="overflow-x-auto" style="display:none;">
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Dados da Planilha</h4>
                        <table class="min-w-full divide-y divide-gray-200" id="erp-data-table">
                            <thead class="bg-gray-50" id="erp-table-head"></thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="erp-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ERP: Items View (DEPRECATED - Manter por compatibilidade) -->
            <div id="items-view" class="view-container hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Itens do Cardápio</h3>
                        <div class="flex gap-2">
                            <button onclick="handleAuthClick()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2" id="connect-google-btn">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Conectar Google Sheets
                            </button>
                            <button onclick="handleSignoutClick()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2" id="disconnect-google-btn" style="display:none;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                Desconectar
                            </button>
                            <button onclick="loadAllDataFromSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Sincronizar Todas as Abas
                            </button>
                            <button onclick="exportItems()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                            <button onclick="showAddItemModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Adicionar Item
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="mb-4 flex gap-3">
                        <input type="text" id="item-search" placeholder="Buscar item..." class="flex-1 px-4 py-2 border rounded-lg" oninput="filterItems()">
                        <select id="item-category-filter" class="px-4 py-2 border rounded-lg" onchange="filterItems()">
                            <option value="">Todas as categorias</option>
                        </select>
                        <select id="item-status-filter" class="px-4 py-2 border rounded-lg" onchange="filterItems()">
                            <option value="">Todos os status</option>
                            <option value="active">Ativo</option>
                            <option value="inactive">Inativo</option>
                        </select>
                    </div>

                    <!-- Tabela de Itens -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Imagem</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Preço</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Linhas serão inseridas dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ERP: Categories View -->
            <div id="categories-view" class="view-container hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Categorias</h3>
                        <div class="flex gap-2">
                            <button onclick="loadAllDataFromSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Sincronizar Todas as Abas
                            </button>
                            <button onclick="exportCategories()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                            <button onclick="showAddCategoryModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Adicionar Categoria
                            </button>
                        </div>
                    </div>

                    <!-- Grid de Categorias -->
                    <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Cards serão inseridos dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- ERP: Hours View -->
            <div id="hours-view" class="view-container hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Horários de Funcionamento</h3>
                        <div class="flex gap-2">
                            <button onclick="loadAllDataFromSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Sincronizar Todas as Abas
                            </button>
                            <button onclick="exportHours()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                        </div>
                    </div>

                    <!-- Tabela de Horários -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dia da Semana</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Abertura</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fechamento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="hours-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Linhas serão inseridas dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ERP: Neighborhoods View -->
            <div id="neighborhoods-view" class="view-container hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Gerenciar Bairros e Taxas de Entrega</h3>
                        <div class="flex gap-2">
                            <button onclick="loadAllDataFromSheets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                Sincronizar Todas as Abas
                            </button>
                            <button onclick="exportNeighborhoods()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                            <button onclick="showAddNeighborhoodModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                Adicionar Bairro
                            </button>
                        </div>
                    </div>

                    <!-- Tabela de Bairros -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bairro</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Taxa de Entrega</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tempo Estimado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="neighborhoods-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Linhas serão inseridas dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ERP: Config View -->
            <div id="config-view" class="view-container hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Configurações Gerais</h3>
                        <button onclick="syncConfigFromSheet()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            Sincronizar Planilha
                        </button>
                    </div>

                    <!-- Abas de Configuração -->
                    <div class="mb-6">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="showConfigTab('general')" class="config-tab-btn active border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-600">Geral</button>
                                <button onclick="showConfigTab('colors')" class="config-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Cores</button>
                                <button onclick="showConfigTab('payment')" class="config-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Pagamento</button>
                                <button onclick="showConfigTab('delivery')" class="config-tab-btn border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">Entrega</button>
                            </nav>
                        </div>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div id="config-general" class="config-tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Estabelecimento</label>
                                <input type="text" id="config-restaurant-name" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                                <input type="text" id="config-phone" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                <input type="text" id="config-address" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp</label>
                                <input type="text" id="config-whatsapp" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <button onclick="saveConfig('general')" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar Configurações</button>
                    </div>

                    <div id="config-colors" class="config-tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cor Primária</label>
                                <input type="color" id="config-color-primary" class="w-full h-12 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cor Secundária</label>
                                <input type="color" id="config-color-secondary" class="w-full h-12 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cor Terciária</label>
                                <input type="color" id="config-color-tertiary" class="w-full h-12 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cor de Fundo</label>
                                <input type="color" id="config-color-background" class="w-full h-12 border rounded-lg">
                            </div>
                        </div>
                        <button onclick="saveConfig('colors')" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar Cores</button>
                    </div>

                    <div id="config-payment" class="config-tab-content hidden">
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-800">Formas de Pagamento Aceitas</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="payment-dinheiro" class="rounded">
                                    <span>Dinheiro</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="payment-pix" class="rounded">
                                    <span>PIX</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="payment-credito" class="rounded">
                                    <span>Cartão de Crédito</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="payment-debito" class="rounded">
                                    <span>Cartão de Débito</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="saveConfig('payment')" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar Pagamentos</button>
                    </div>

                    <div id="config-delivery" class="config-tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Taxa de Entrega Padrão</label>
                                <input type="number" step="0.01" id="config-delivery-fee" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tempo de Entrega Estimado (min)</label>
                                <input type="number" id="config-delivery-time" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pedido Mínimo</label>
                                <input type="number" step="0.01" id="config-min-order" class="w-full px-4 py-2 border rounded-lg">
                            </div>
                        </div>
                        <button onclick="saveConfig('delivery')" class="mt-6 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar Entrega</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Área de Impressão (oculta) -->
    <div id="print-content" class="print-area"></div>

    <!-- Modal: Adicionar/Editar Item -->
    <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[10001]" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 id="item-modal-title" class="text-2xl font-bold text-gray-800">Adicionar Item</h3>
            </div>
            <div class="p-6">
                <form id="item-form" onsubmit="saveItemForm(event)">
                    <input type="hidden" id="item-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Item *</label>
                            <input type="text" id="item-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Categoria *</label>
                            <select id="item-category" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Preço *</label>
                            <input type="text" id="item-price" required placeholder="35.90" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                            <textarea id="item-description" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">URL da Imagem</label>
                            <input type="url" id="item-image" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeItemModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Categoria -->
    <div id="category-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[10001]" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 id="category-modal-title" class="text-2xl font-bold text-gray-800">Adicionar Categoria</h3>
            </div>
            <div class="p-6">
                <form id="category-form" onsubmit="saveCategoryForm(event)">
                    <input type="hidden" id="category-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Categoria *</label>
                            <input type="text" id="category-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ícone (Emoji) *</label>
                            <input type="text" id="category-icon" required placeholder="🍕" maxlength="2" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ordem de Exibição *</label>
                            <input type="number" id="category-order" required min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeCategoryModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Horário -->
    <div id="hour-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[10001]" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 class="text-2xl font-bold text-gray-800">Editar Horário</h3>
            </div>
            <div class="p-6">
                <form id="hour-form" onsubmit="saveHourForm(event)">
                    <input type="hidden" id="hour-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Dia da Semana</label>
                            <input type="text" id="hour-day" readonly class="w-full px-4 py-2 border rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horário de Abertura *</label>
                            <input type="time" id="hour-open" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horário de Fechamento *</label>
                            <input type="time" id="hour-close" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeHourModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Bairro -->
    <div id="neighborhood-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[10001]" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b">
                <h3 id="neighborhood-modal-title" class="text-2xl font-bold text-gray-800">Adicionar Bairro</h3>
            </div>
            <div class="p-6">
                <form id="neighborhood-form" onsubmit="saveNeighborhoodForm(event)">
                    <input type="hidden" id="neighborhood-id">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Bairro *</label>
                            <input type="text" id="neighborhood-name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Taxa de Entrega (R$) *</label>
                            <input type="text" id="neighborhood-fee" required placeholder="5.00" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tempo Estimado *</label>
                            <input type="text" id="neighborhood-time" required placeholder="30-40 min" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeNeighborhoodModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: ERP Add/Edit Row -->
    <div id="erp-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[10001]" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <h3 id="erp-modal-title" class="text-2xl font-bold text-gray-800">Adicionar Nova Linha</h3>
            </div>
            <div class="p-6">
                <form id="erp-form" onsubmit="saveERPRow(event)">
                    <input type="hidden" id="erp-row-index">
                    <div id="erp-form-fields" class="space-y-4">
                        <!-- Campos serão inseridos dinamicamente -->
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" onclick="closeERPModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Cliente Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Biblioteca SortableJS para Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <!-- Funções ERP -->
    <script src="erp-functions.js"></script>

    <script>
        // ====================================================================
        // DADOS DO ERP (Declarado antes de tudo)
        // ====================================================================
        let erpData = {
            items: [],
            categories: [],
            hours: [],
            neighborhoods: [],
            config: {}
        };

        // --- INÍCIO: Lógica de Logout ---
        async function logout() {
            if (confirm('Tem certeza que deseja sair do painel?')) {
                // Mostra o overlay de loading
                document.getElementById('logout-overlay').classList.add('active');
                
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Erro ao fazer logout:', error);
                    // Remove o overlay em caso de erro
                    document.getElementById('logout-overlay').classList.remove('active');
                    alert('Erro ao fazer logout. Tente novamente.');
                    return;
                }
                
                // Aguarda um pouco para a animação ser visível antes de redirecionar
                setTimeout(() => {
                    window.location.href = 'login.html'; // Redireciona para login ao sair
                }, 500);
            }
        }
        // --- FIM: Lógica de Logout ---

        // --- INÍCIO: Sistema de Notificação (Toast) ---

        /**
         * Exibe uma notificação (toast) na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de notificação ('success', 'error', 'warning').
         * @param {number} duration - A duração em milissegundos.
         */
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = `toast-${Date.now()}`;
            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `
                <div class="toast-notification-icon">${icons[type] || 'ℹ️'}</div>
                <div class="toast-notification-content">
                    <p class="font-semibold text-sm">${message}</p>
                </div>
                <button class="toast-notification-close" onclick="document.getElementById('${toastId}').remove()">&times;</button>
            `;

            container.appendChild(toast);

            // Animação de entrada
            setTimeout(() => toast.classList.add('show'), 10);

            // Animação de saída e remoção
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, duration);
        }

        // --- FIM: Sistema de Notificação (Toast) ---
        // --- INÍCIO: Lógica para Busca e Tela Cheia ---

        function handleSearch() {
            applyFilter(); // A função de filtro agora considera a busca
        }

        function toggleFullScreen() {
            const body = document.body;
            const openIcon = document.getElementById('fullscreen-icon-open');
            const closeIcon = document.getElementById('fullscreen-icon-close');

            body.classList.toggle('fullscreen-mode');

            const isFullScreen = body.classList.contains('fullscreen-mode');
            openIcon.classList.toggle('hidden', isFullScreen);
            closeIcon.classList.toggle('hidden', !isFullScreen);

            if (isFullScreen) {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) { /* Firefox */
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) { /* Chrome, Safari & Opera */
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) { /* IE/Edge */
                    document.documentElement.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // --- FIM: Lógica para Busca e Tela Cheia ---
        // --- INÍCIO: Lógica para Cores e Responsividade ---

        // Função para aplicar as cores do cardápio
        async function applyMenuColors() {
            try {
                const response = await fetch(CONFIG_CSV_URL);
                const csvText = await response.text();
                const rows = csvText.split('\n');
                const config = {};

                rows.forEach(row => {
                    const [section, key, value] = row.split(',').map(s => s.trim());
                    if (section && key && value) {
                        if (!config[section]) config[section] = {};
                        config[section][key] = value;
                    }
                });

                const root = document.documentElement;
                const cores = config.cores || {};

                if (cores.cor_primaria) root.style.setProperty('--cor-primaria', cores.cor_primaria);
                if (cores.cor_secundaria) root.style.setProperty('--cor-secundaria', cores.cor_secundaria);
                if (cores.cor_terciaria) root.style.setProperty('--cor-terciaria', cores.cor_terciaria);
                if (cores.cor_fundo) root.style.setProperty('--cor-fundo', cores.cor_fundo);
                if (cores.cor_texto) root.style.setProperty('--cor-texto', cores.cor_texto);
                if (cores.cor_sucesso) root.style.setProperty('--cor-sucesso', cores.cor_sucesso);
                if (cores.cor_erro) root.style.setProperty('--cor-erro', cores.cor_erro);
                if (cores.cor_aviso) root.style.setProperty('--cor-aviso', cores.cor_aviso);
                if (cores.cor_borda) root.style.setProperty('--cor-borda', cores.cor_borda);

                // Cores de fundo para status
                if (cores.cor_sucesso_fundo) root.style.setProperty('--cor-sucesso-fundo', cores.cor_sucesso_fundo);
                if (cores.cor_erro_fundo) root.style.setProperty('--cor-erro-fundo', cores.cor_erro_fundo);
                if (cores.cor_aviso_fundo) root.style.setProperty('--cor-aviso-fundo', cores.cor_aviso_fundo);

                // Cores RGB para animações
                function hexToRgb(hex) {
                    let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
                }

                if (cores.cor_sucesso) root.style.setProperty('--cor-sucesso-rgb', hexToRgb(cores.cor_sucesso));
                if (cores.cor_erro) root.style.setProperty('--cor-erro-rgb', hexToRgb(cores.cor_erro));

                console.log('[Cores] Cores do cardápio aplicadas com sucesso.');

            } catch (error) {
                console.error('[Cores] Erro ao carregar e aplicar as cores:', error);
            }
        }

        // Lógica para o menu lateral responsivo
        function setupResponsiveSidebar() {
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');

            if (menuToggle && sidebar && mainContent) {
                menuToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('-translate-x-full');
                });

                // Fechar sidebar ao clicar fora dela em modo mobile
                document.addEventListener('click', (event) => {
                    if (window.innerWidth < 768) { // Apenas em modo mobile
                        const isClickInsideSidebar = sidebar.contains(event.target);
                        const isClickOnToggle = menuToggle.contains(event.target);

                        if (!isClickInsideSidebar && !isClickOnToggle && !sidebar.classList.contains('-translate-x-full')) {
                            sidebar.classList.add('-translate-x-full');
                        }
                    }
                });

                // Fechar sidebar ao clicar em um botão de navegação
                document.querySelectorAll('.sidebar-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        if (window.innerWidth < 768) {
                            sidebar.classList.add('-translate-x-full');
                        }
                        // Atualiza o botão ativo
                        document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    });
                });
            }
        }

        // --- FIM: Lógica para Cores e Responsividade ---

        function showView(viewId) {
            // Esconde todas as views
            document.querySelectorAll('.view-container').forEach(view => {
                view.classList.add('hidden');
            });
            // Mostra a view selecionada
            document.getElementById(viewId).classList.remove('hidden');

            // Mapa de títulos
            const viewTitles = {
                'kanban-view': 'Painel de Pedidos',
                'finance-view': 'Financeiro',
                'erp-view': '📊 Google Sheets ERP'
            };

            // Atualiza o título da página
            document.getElementById('view-title').textContent = viewTitles[viewId] || 'Painel Admin';
            document.getElementById('order-filters').style.display = viewId === 'kanban-view' ? 'flex' : 'none';
            document.getElementById('search-container').style.display = viewId === 'kanban-view' ? 'block' : 'none';

            // Carrega dados específicos de cada view
            if (viewId === 'finance-view') {
                setTimeout(() => filterSales('today'), 50);
            }
        }

        // Variável global para a instância do gráfico
        let paymentChart = null;

        let canceledOrderSound = new Audio('https://cdn.pixabay.com/audio/2022/11/21/audio_136661e554.mp3');
        let lastOrders = [];
        let newOrderSound = new Audio('https://cdn.pixabay.com/audio/2025/05/06/audio_2fd68b9a9a.mp3');
        let soundEnabled = true;
        let currentFilter = 'all'; // Filtro atual: 'all', 'delivery', 'pickup'
        // O nome do restaurante será carregado dinamicamente
        const RESTAURANT_NAME = "Pizzaria Sol Nascente";

        // Trava para evitar que pedidos mudem de status sozinhos
        let recentlyUpdatedOrders = new Map();
        
        // Cache de elementos DOM para melhor performance
        const domCache = {
            columns: {},
            counters: {},
            initialized: false
        };
        
        // Debounce para atualização dos contadores
        let updateCountersTimeout = null;
        
        // Inicializa o cache de elementos DOM
        function initDOMCache() {
            if (domCache.initialized) return;
            
            const columnIds = ['column-novo', 'column-em-preparo', 'column-finalizado', 'column-cancelado'];
            const counterIds = ['count-novo', 'count-em-preparo', 'count-finalizado', 'count-cancelado'];
            
            columnIds.forEach(id => {
                domCache.columns[id] = document.getElementById(id);
            });
            
            counterIds.forEach(id => {
                domCache.counters[id] = document.getElementById(id);
            });
            
            domCache.initialized = true;
            console.log('[Cache DOM] Elementos cacheados para melhor performance');
        }
        
        /**
         * Alterna entre mostrar todos os cards ou apenas os 3 primeiros de uma coluna
         * @param {string} columnName - Nome da coluna (novo, em-preparo, finalizado, cancelado)
         */
        function toggleColumn(columnName) {
            const column = document.getElementById(`column-${columnName}`);
            const button = document.getElementById(`toggle-${columnName}`);
            
            if (!column || !button) return;
            
            const isCollapsed = column.dataset.collapsed === 'true';
            
            // Alterna o estado
            column.dataset.collapsed = isCollapsed ? 'false' : 'true';
            
            // Atualiza o texto do botão
            const expandText = button.querySelector('.expand-text');
            const collapseText = button.querySelector('.collapse-text');
            
            if (isCollapsed) {
                // Expandindo - mostrar "Ver menos"
                expandText.classList.add('hidden');
                collapseText.classList.remove('hidden');
            } else {
                // Colapsando - mostrar "Ver mais"
                expandText.classList.remove('hidden');
                collapseText.classList.add('hidden');
            }
            
            console.log(`[Toggle] Coluna ${columnName} ${isCollapsed ? 'expandida' : 'colapsada'}`);
        }
        
        /**
         * Atualiza a visibilidade dos botões "Ver mais" baseado no número de cards visíveis
         */
        function updateToggleButtons() {
            const columns = ['novo', 'em-preparo', 'finalizado', 'cancelado'];
            
            columns.forEach(columnName => {
                const column = document.getElementById(`column-${columnName}`);
                const button = document.getElementById(`toggle-${columnName}`);
                
                if (!column || !button) return;
                
                // Conta apenas cards visíveis (não filtrados)
                const visibleCards = Array.from(column.children).filter(
                    card => card.style.display !== 'none'
                );
                
                // Mostra o botão apenas se houver mais de 3 cards visíveis
                if (visibleCards.length > 3) {
                    button.classList.remove('hidden');
                    // Se a coluna não estava colapsada, colapsa automaticamente
                    if (column.dataset.collapsed === 'false') {
                        column.dataset.collapsed = 'true';
                    }
                } else {
                    button.classList.add('hidden');
                    // Se houver 3 ou menos, sempre mostra todos
                    column.dataset.collapsed = 'false';
                }
            });
        }

        function renderOrderCard(order) {
            const statusColors = {
                'Novo': 'new-order', // A cor da borda é controlada pela classe .new-order
                'Em Preparo': 'border-yellow-500', // Usando fallback, será sobrescrito pelo CSS var
                'Finalizado': 'border-gray-400 opacity-50',
                'Cancelado': 'border-red-400 opacity-50'
            };
            const statusColorClass = statusColors[order.status] || 'border-gray-300';
            const isFinalizado = order.status === 'Finalizado';
            const isDisabled = order.status === 'Cancelado';
            const isCancelado = order.status === 'Cancelado';

            const card = document.createElement('div');

            // Checagem extra para garantir que nenhum pedido com o mesmo ID seja renderizado mais de uma vez
            if (document.getElementById(`order-${order.id}`)) {
                console.warn(`[Duplicação Bloqueada] Tentativa de renderizar o pedido #${order.order_id} que já existe no DOM.`);
                // Retorna null para indicar que a renderização foi bloqueada.
                return null;
            }
            // Checagem extra para garantir que nenhum pedido com o mesmo ID seja renderizado mais de uma vez
            if (document.getElementById(`order-${order.id}`)) {
                console.warn(`[Duplicação Bloqueada] Tentativa de renderizar o pedido #${order.id} que já existe no DOM.`);
                // Retorna null para indicar que a renderização foi bloqueada.
                return null;
            }

            card.className = `order-card bg-white p-4 rounded-lg shadow-md border-l-4 ${statusColorClass} transition-all duration-300`;
        if (isCancelado) {
                card.classList.add('not-draggable');
                card.dataset.draggable = 'false';
            }

            card.id = `order-${order.id}`;
            card.dataset.type = order.delivery_type; // Adiciona o tipo de pedido para filtragem

            const deliveryTypes = {
                'local': { icon: '🍽️', text: 'Consumir no Local' },
                'pickup': { icon: '🥡', text: 'Retirar no Balcão' },
                'delivery': { icon: '🛵', text: 'Delivery' },
                'default': { icon: '📋', text: 'Padrão' }
            };
            const deliveryInfo = deliveryTypes[order.delivery_type] || deliveryTypes['default'];

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h2 class="font-bold text-base text-gray-800">${order.customer_name || 'Cliente não informado'}</h2>
                        <p class="text-xs text-gray-500">${new Date(order.created_at).toLocaleString('pt-BR')}</p>
                    </div>
                    <span class="text-xs font-mono bg-gray-200 text-gray-700 px-2 py-1 rounded-md">${order.order_id}</span>
                </div>

                <div class="my-3 py-3 border-t border-b border-gray-200 space-y-2">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-gray-600 flex items-center">${deliveryInfo.icon} <span class="ml-1.5">${deliveryInfo.text}</span></span>
                        <span class="font-bold text-lg" style="color: var(--cor-primaria);">${formatCurrency(order.total)}</span>
                    </div>
                </div>

                <div class="space-y-2 text-sm mb-4">
                    <h4 class="font-semibold text-gray-700">Itens do Pedido:</h4>
                    <div class="space-y-2">
                            ${(() => {
                                // Agora os itens são um objeto JSON
                                try {
                                    const items = Array.isArray(order.items) ? order.items : [];
                                    return items.map(item => {
                                        let itemHtml = `<div class="bg-gray-50 p-2 rounded-md text-gray-800"><strong>${item.quantity}x ${item.nome}</strong>`;
                                        if (item.variationText) itemHtml += `<br>&nbsp;&nbsp;└ <span class="text-gray-600">Com: ${item.variationText.replace(/\n/g, ', ')}</span>`;
                                        if (item.notes) itemHtml += `<br>&nbsp;&nbsp;└ <span class="text-blue-600">Obs: ${item.notes}</span>`;
                                        itemHtml += `</div>`;
                                        return itemHtml;
                                    }).join('');
                                } catch (e) {
                                    return `<div class="bg-gray-50 p-2 rounded-md text-gray-800">Erro ao ler itens.</div>`;
                                }
                            })()}
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="border-t pt-3 mt-3 flex flex-wrap gap-2 justify-end">
                    ${(order.status === 'Novo') ? `
                        <button onclick="cancelOrder('${order.id}')" class="status-btn text-xs text-white px-3 py-2 rounded" style="background-color: var(--cor-erro);" title="Cancelar este pedido">Cancelar Pedido</button>
                    ` : ''}
                    ${!isDisabled ? `<button onclick="generateAndPrintPDF(this)" class="status-btn text-xs bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Imprimir Pedido</button>` : ''}
                </div>
            `;
            card.dataset.order = JSON.stringify(order);
            card.dataset.status = order.status;
            return card;
        }

        // Atualiza o conteúdo de um card sem recriá-lo (mais eficiente)
        function updateCardContent(card, order) {
            try {
                // Atualiza o dataset
                card.dataset.order = JSON.stringify(order);
                card.dataset.status = order.status;
                
                // Atualiza elementos específicos que podem ter mudado
                const totalElement = card.querySelector('.font-bold.text-lg');
                if (totalElement) {
                    const oldValue = totalElement.textContent;
                    const newValue = formatCurrency(order.total);
                    
                    if (oldValue !== newValue) {
                        totalElement.textContent = newValue;
                        
                        // Animação sutil no valor atualizado
                        totalElement.style.transition = 'transform 0.2s ease';
                        totalElement.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            totalElement.style.transform = 'scale(1)';
                        }, 200);
                    }
                }
                
                // Adiciona feedback visual de atualização usando classe CSS
                card.classList.add('updating');
                setTimeout(() => {
                    card.classList.remove('updating');
                }, 500);
                
                console.log(`[Update] Card do pedido #${order.order_id} atualizado in-place`);
            } catch (error) {
                console.error('[Update] Erro ao atualizar card:', error);
            }
        }
        
        function getColumnForStatus(status) {
            if (!domCache.initialized) initDOMCache();
            
            const statusMap = {
                'Novo': 'column-novo',
                'Em Preparo': 'column-em-preparo',
                'Finalizado': 'column-finalizado',
                'Cancelado': 'column-cancelado'
            };
            const columnId = statusMap[status];
            
            // Usa cache se disponível
            return domCache.columns[columnId] || document.getElementById(columnId);
        }

        function moveCardToColumn(card, newStatus) {
            const targetColumn = getColumnForStatus(newStatus);
            if (targetColumn) {
                // Animação de saída
                card.classList.add('moving');
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    targetColumn.prepend(card);
                    // Animação de entrada
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                    setTimeout(() => card.classList.remove('moving'), 300);
                    updateColumnCounts();
                }, 300);
            } else {
                // Se for para um status sem coluna visível permanentemente, remove o card após um tempo
                console.log(`[Remoção Agendada] Pedido ${card.id.replace('order-','')} movido para status temporário (${newStatus}). Removendo em 30s.`);
                setTimeout(() => {
                    card.remove();
                    updateColumnCounts();
                }, 30000); // Remove o card da tela após 30 segundos
            }
        }

        async function changeStatus(orderId, newStatus, extraData = {}) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) card.style.opacity = '0.5'; // Feedback visual imediato

            // Extrai o ID legível do pedido (ex: YT6A3339) do dataset do card.
            const orderData = JSON.parse(card.dataset.order);
            const readableOrderId = orderData.order_id;

            try {
                // Atualiza o status diretamente no Supabase
                const { data, error } = await supabase
                    .from('pedidos')
                    .update({ status: newStatus, ...extraData })
                    .eq('id', orderId)
                    .select(); // Necessário para retornar os dados atualizados

                if (error) {
                    console.error('Detalhes do erro:', error);
                    throw error;
                }

                console.log(`[Supabase] Status do pedido ${readableOrderId} (${orderId}) atualizado para ${newStatus}.`);

                // Se o pedido foi finalizado, notificar o cliente.
                if (newStatus === 'Finalizado') {
                    notifyCustomer(orderId);
                } else if (newStatus === 'Em Preparo') {                    notifyPreparation(orderId);
                }

            } catch (error) {
                console.error('Erro ao mudar status via Supabase:', error);
                alert('Falha ao atualizar o status. Verifique o console e a conexão.');
                if(card) card.style.opacity = '1';
            }
        }

        async function cancelOrder(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            const orderData = JSON.parse(card.dataset.order);

            if (confirm(`Tem certeza que deseja cancelar o pedido #${orderData.order_id}?`)) {
                console.log(`[Cancelamento] Usuário confirmou o cancelamento do pedido #${orderData.order_id}.`);
                await changeStatus(orderId, 'Cancelado');

                // Mover o card para a coluna de cancelados e agendar remoção
                const canceledColumn = document.getElementById('column-cancelado');
                if (canceledColumn) {
                    canceledColumn.prepend(card);
                    updateColumnCounts();
                    setTimeout(() => card.remove(), 30000); // Remove após 30 segundos
                }
            }
        }

        // Função auxiliar para abrir WhatsApp reutilizando a aba se já estiver aberta
        function openWhatsApp(url) {
            console.log('🔍 Estado da janela:', {
                exists: !!whatsappWindow,
                closed: whatsappWindow ? whatsappWindow.closed : 'N/A'
            });
            
            try {
                // Verificar se a janela existe e ainda está aberta
                if (whatsappWindow) {
                    try {
                        // Tenta acessar a propriedade closed
                        const isClosed = whatsappWindow.closed;
                        console.log('📊 Janela fechada?', isClosed);
                        
                        if (!isClosed) {
                            console.log('♻️ Reutilizando aba do WhatsApp já aberta');
                            whatsappWindow.location.href = url;
                            whatsappWindow.focus();
                            console.log('✅ Aba reutilizada com sucesso');
                            return;
                        }
                    } catch (e) {
                        console.warn('⚠️ Não foi possível verificar estado da janela:', e);
                        // Se não conseguir verificar, assume que está fechada
                    }
                }
                
                // Se chegou aqui, precisa abrir nova janela
                console.log('🆕 Abrindo aba do WhatsApp');
                
                // Abre diretamente a URL da conversa (mais confiável)
                whatsappWindow = window.open(url, 'whatsapp_window');
                
                if (!whatsappWindow) {
                    console.error('❌ Bloqueador de pop-up pode estar ativo');
                    alert('Por favor, permita pop-ups para este site para abrir o WhatsApp');
                    return;
                }
                
                console.log('✅ Janela do WhatsApp aberta com sucesso');
                
            } catch (error) {
                console.error('❌ Erro ao abrir WhatsApp:', error);
                // Fallback: tentar abrir normalmente
                whatsappWindow = window.open(url, 'whatsapp_window');
            }
        }

        function notifyCustomer(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (!card) return;

            const order = JSON.parse(card.dataset.order);
            const customerName = order.customer_name;
            let customerPhone = order.customer_phone ? String(order.customer_phone).replace(/\D/g, '') : '';

            console.log('📱 Telefone original:', order.customer_phone);
            console.log('📱 Telefone limpo:', customerPhone);
            console.log('📱 Tamanho do telefone:', customerPhone.length);

            if (!customerPhone) {
                alert(`❌ Não é possível notificar: telefone não encontrado no pedido #${order.order_id}`);
                console.warn(`Não é possível notificar o pedido #${order.order_id}: telefone não encontrado.`);
                return;
            }

            // Verificar se já tem código do país
            // Se tem 13 dígitos (55 + 11 dígitos), já está completo
            // Se tem 12 dígitos (55 + 10 dígitos), já está completo
            // Se tem 11 dígitos sem 55, adicionar
            // Se tem 10 dígitos sem 55, adicionar
            if (customerPhone.length === 11 && !customerPhone.startsWith('55')) {
                customerPhone = '55' + customerPhone;
                console.log('📱 Adicionado código 55 (11 dígitos):', customerPhone);
            } else if (customerPhone.length === 10 && !customerPhone.startsWith('55')) {
                customerPhone = '55' + customerPhone;
                console.log('📱 Adicionado código 55 (10 dígitos):', customerPhone);
            } else if (customerPhone.length === 13 || customerPhone.length === 12) {
                console.log('📱 Telefone já possui código do país:', customerPhone);
            } else {
                console.warn('⚠️ Formato de telefone inesperado:', customerPhone);
            }

            console.log('📱 Telefone final para WhatsApp:', customerPhone);

            // Perguntar ao usuário se deseja notificar
            const confirmation = confirm(`Deseja notificar ${customerName} no WhatsApp que o pedido #${order.order_id} está pronto?\n\nNúmero: ${customerPhone}`);
            
            if (!confirmation) {
                console.log('❌ Usuário cancelou a notificação');
                return;
            }

            // Criar mensagem
            console.log('🚀 Preparando mensagem...');
            
            let message = `Olá👋, ${customerName}!\n\nSeu pedido *#${order.order_id}* na ${RESTAURANT_NAME} está pronto!✅`;
            if (order.delivery_type === 'delivery') {
                message += `\n\nO motoboy já saiu para fazer a sua entrega 🛵. Bom apetite!`;
            } else if (order.delivery_type === 'pickup') {
                message += `\n\nPode vir buscá-lo em nosso balcão.`;
            }
            
            // Codificar mensagem corretamente para WhatsApp
            const encodedMessage = encodeURIComponent(message);
            
            // Usar api.whatsapp.com que funciona melhor com app desktop/mobile
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${customerPhone}&text=${encodedMessage}`;

            console.log('📝 Mensagem original:', message);
            console.log('🔗 URL do WhatsApp:', whatsappUrl);
            console.log('📝 Mensagem codificada:', encodedMessage);

            // Abrir WhatsApp usando a função auxiliar
            console.log('🌐 Abrindo WhatsApp...');
            openWhatsApp(whatsappUrl);
            console.log('✅ WhatsApp deve abrir em instantes!');
        }

        function notifyPreparation(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (!card) return;

            const order = JSON.parse(card.dataset.order);
            const customerName = order.customer_name;
            let customerPhone = order.customer_phone ? String(order.customer_phone).replace(/\D/g, '') : '';

            console.log('📱 [Preparo] Telefone original:', order.customer_phone);
            console.log('📱 [Preparo] Telefone limpo:', customerPhone);
            console.log('📱 [Preparo] Tamanho do telefone:', customerPhone.length);

            if (!customerPhone) {
                alert(`❌ Não é possível notificar: telefone não encontrado no pedido #${order.order_id}`);
                console.warn(`Não é possível notificar o pedido ${order.order_id} sobre o preparo: telefone não encontrado.`);
                return;
            }

            // Verificar se já tem código do país
            if (customerPhone.length === 11 && !customerPhone.startsWith('55')) {
                customerPhone = '55' + customerPhone;
                console.log('📱 [Preparo] Adicionado código 55 (11 dígitos):', customerPhone);
            } else if (customerPhone.length === 10 && !customerPhone.startsWith('55')) {
                customerPhone = '55' + customerPhone;
                console.log('📱 [Preparo] Adicionado código 55 (10 dígitos):', customerPhone);
            } else if (customerPhone.length === 13 || customerPhone.length === 12) {
                console.log('📱 [Preparo] Telefone já possui código do país:', customerPhone);
            } else {
                console.warn('⚠️ [Preparo] Formato de telefone inesperado:', customerPhone);
            }

            console.log('📱 [Preparo] Telefone final para WhatsApp:', customerPhone);

            // Perguntar ao usuário se deseja notificar
            const confirmation = confirm(`Deseja notificar ${customerName} que o pedido #${order.order_id} foi aceito e está em preparo?\n\nNúmero: ${customerPhone}`);
            
            if (!confirmation) {
                console.log('❌ [Preparo] Usuário cancelou a notificação');
                return;
            }

            // Criar mensagem
            console.log('🚀 [Preparo] Preparando mensagem...');
            
            const message = `Olá👋, ${customerName}! Seu pedido *#${order.order_id}* foi aceito na ${RESTAURANT_NAME} e já estamos preparando. Logo mais ele estará pronto!👨‍🍳`;
            
            // Codificar mensagem corretamente para WhatsApp
            const encodedMessage = encodeURIComponent(message);
            
            // Usar api.whatsapp.com que funciona melhor com app desktop/mobile
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${customerPhone}&text=${encodedMessage}`;

            console.log('📝 [Preparo] Mensagem original:', message);
            console.log('🔗 [Preparo] URL do WhatsApp:', whatsappUrl);
            console.log('📝 [Preparo] Mensagem codificada:', encodedMessage);

            // Abrir WhatsApp usando a função auxiliar
            console.log('🌐 [Preparo] Abrindo WhatsApp...');
            openWhatsApp(whatsappUrl);
            console.log('✅ [Preparo] WhatsApp deve abrir em instantes!');
        }

        async function generateAndPrintPDF(button) {
            const card = button.closest('.order-card');
            const order = JSON.parse(card.dataset.order);
            
            // Debug: Verificar dados do pedido
            console.log('[PDF] Dados do pedido:', order);
            console.log('[PDF] Forma de pagamento:', order.payment_method);
            console.log('[PDF] Valor de troco:', order.change_amount);
            
            button.textContent = 'Gerando...';
            button.disabled = true;

            // Função para formatar o subtotal de cada item
            function getItemSubtotal(item) {
                // Tenta obter o preço do item, que pode ser um número ou string
                const price = parseFloat(String(item.price || item.preco || 0).replace(',', '.'));
                const quantity = parseInt(item.quantity || 1, 10);
                return price * quantity;
            }

            let itemsHtml = '';
            try {
                // Itens agora são um objeto JSON
                const items = Array.isArray(order.items) ? order.items : [];
                items.forEach((item, index) => {
                    const subtotal = getItemSubtotal(item);
                    itemsHtml += `
                        <div class="item">
                            <div class="item-info"> 
                                <span class="item-name">
                                    <span class="item-qty">${item.quantity}x</span> ${item.nome}
                                </span>
                                <span class="price">${formatCurrency(subtotal)}</span>
                            </div>
                            ${item.variationText ? `<div class="item-details">✓ ${item.variationText.replace(/\n/g, '\n✓ ')}</div>` : ''}
                            ${item.notes ? `<div class="item-details obs">⚠️ ${item.notes}</div>` : ''}
                        </div>
                    `;
                });
            } catch (e) {
                // Fallback para o formato antigo, caso o JSON falhe
                itemsHtml = `<div class="item"><div class="item-info"><span>${order.itens || 'Nenhum item informado'}</span></div></div>`;
            }

            const deliveryTypes = { 'local': 'Consumir no Local', 'pickup': 'Retirar no Balcão', 'delivery': 'Delivery', 'default': 'Padrão' };
            const deliveryText = deliveryTypes[order.delivery_type] || 'Não informado';

            const content = `
                <div class="receipt">
                    <div class="header">
                        <div class="store-name">${RESTAURANT_NAME.toUpperCase()}</div>
                        <div class="separator"></div>
                        <div class="order-number">PEDIDO #${order.order_id}</div>
                        <div class="order-date">${new Date(order.created_at).toLocaleString('pt-BR', { 
                            day: '2-digit',
                            month: '2-digit', 
                            year: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })}</div>
                        <div class="separator">═══════════════════════════════</div>
                    </div>

                    <div class="section">
                        <div class="title">👤 DADOS DO CLIENTE</div>
                        <div class="info-line"><span class="label">👤 Nome:</span> <span class="value">${order.customer_name || 'N/A'}</span></div>
                        <div class="info-line"><span class="label">📞 Telefone:</span> <span class="value">${order.customer_phone || 'Não informado'}</span></div>
                        <div class="info-line full-width"><span class="label">📍 Tipo:</span> <span class="value">${deliveryText}</span></div>
                        ${(() => {
                            if (order.delivery_type === 'delivery' && order.address) {
                                const addressParts = order.address.split('|').map(p => p ? p.trim() : '');
                                let street = '', number = '', complement = '';
                                const neighborhood = addressParts[1] || '';
                                const city = addressParts[2] || '';

                                if (addressParts[0]) {
                                    const firstPart = addressParts[0];
                                    // Formato: "Rua, Número - Complemento" ou "Rua, Número"
                                    const parts = firstPart.split(',').map(p => p.trim());
                                    
                                    if (parts.length >= 2) {
                                        street = parts[0];
                                        // Separar número e complemento (se houver " - ")
                                        const numberAndComplement = parts[1];
                                        if (numberAndComplement.includes(' - ')) {
                                            const splitByDash = numberAndComplement.split(' - ');
                                            number = splitByDash[0].trim();
                                            complement = splitByDash.slice(1).join(' - ').trim();
                                        } else {
                                            number = numberAndComplement;
                                        }
                                    } else {
                                        street = firstPart; // Fallback
                                    }
                                }   
                                return `
                                    <div class="info-line address">
                                        <span class="label">🏠 Endereço:</span>
                                        <span class="value">Rua: ${street}<br>Número: ${number}${complement ? `<br>Complemento: ${complement}` : ''}<br>Bairro: ${neighborhood}<br>Cidade: ${city}</span>
                                    </div>`;
                            } else if (order.delivery_type === 'local' && order.address) {
                                return `<div class="info-line"><span class="label">🪑 Mesa/Comanda:</span> <span class="value">${order.address}</span></div>`;
                            }
                            return '';
                        })()}
                    </div>                    
                    
                    <div class="section">
                        <div class="title">🛍️ ITENS DO PEDIDO</div>
                        <div class="items-container">
                            ${itemsHtml}
                        </div>
                    </div>

                    ${order.notes ? `
                    <div class="section observations">
                        <div class="title">📝 OBSERVAÇÕES</div>
                        <div class="obs-content">${order.notes}</div>
                    </div>
                    ` : ''}
                    
                    <div class="section totals">
                        ${(() => {
                            const subtotal = order.items.reduce((sum, item) => {
                                const price = parseFloat(String(item.price || item.preco || 0).replace(',', '.'));
                                const quantity = parseInt(item.quantity || 1, 10);
                                return sum + (price * quantity);
                            }, 0);

                            const deliveryFee = order.delivery_type === 'delivery' ? (order.total - subtotal) : 0;

                            return `
                                <div class="total-line"><span class="label">Subtotal:</span> <span class="value">${formatCurrency(subtotal)}</span></div>
                                ${deliveryFee > 0 ? `<div class="total-line"><span class="label">Taxa de Entrega:</span> <span class="value">${formatCurrency(deliveryFee)}</span></div>` : ''}
                            `;
                        })()}
                        <div class="separator-thin"></div>
                        <div class="total-line payment">
                            <span class="label" style="text-transform: uppercase; font-weight: bold;">💳 Pagamento:</span>
                            <span class="value">${formatPaymentMethod(order.payment_method)}</span>
                        </div>
                        ${(() => {
                            // Verifica se é pagamento em dinheiro e se há valor de troco
                            console.log('[PDF] Verificando troco - Pagamento:', order.payment_method, 'Change amount:', order.change_amount);
                            
                            if (order.payment_method === 'dinheiro' && order.change_amount) {
                                const changeAmount = parseFloat(String(order.change_amount).replace(',', '.'));
                                const orderTotal = parseFloat(order.total);
                                const changeValue = changeAmount - orderTotal;
                                
                                console.log('[PDF] Cálculo de troco - Valor informado:', changeAmount, 'Total:', orderTotal, 'Troco:', changeValue);
                                
                                if (!isNaN(changeAmount) && !isNaN(orderTotal) && changeValue > 0) {
                                    console.log('[PDF] ✅ Mostrando informação de troco no PDF');
                                    return `
                                        <div class="total-line change-info">
                                            <span class="label">💵 Troco para:</span>
                                            <span class="value">${formatCurrency(changeAmount)}</span>
                                        </div>
                                        <div class="total-line change-info">
                                            <span class="label">💰 Troco:</span>
                                            <span class="value" style="font-weight: bold; color: #059669;">${formatCurrency(changeValue)}</span>
                                        </div>
                                    `;
                                } else {
                                    console.log('[PDF] ❌ Troco não será mostrado - Valor inválido ou zero');
                                }
                            } else {
                                console.log('[PDF] ❌ Troco não será mostrado - Não é dinheiro ou sem change_amount');
                            }
                            return '';
                        })()}
                        <div class="separator-thin"></div>
                        <div class="total-line grand-total">
                            <span class="label">TOTAL A PAGAR:</span>
                            <span class="value">${formatCurrency(order.total)}</span>
                        </div>
                        
                    
                    <div class="footer">
                        <div>Obrigado pela preferência!</div>
                        <div>Volte sempre! 😊</div>
                    </div>
                </div>
            `;

            // Cria um container temporário para calcular altura
            const tempElement = document.createElement('div');
            tempElement.innerHTML = content;
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            tempElement.style.width = '80mm';
            tempElement.style.visibility = 'hidden';

            // Adiciona estilos CSS para a impressão
            const style = document.createElement('style');
            style.innerHTML = `
                * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
                .receipt { 
                    font-size: 11px; 
                    line-height: 1.5; 
                    color: #000; 
                    padding: 5px; 
                    width: 100%; 
                    max-width: 80mm;
                    background: #fff;
                }
                .header { 
                    text-align: center; 
                    margin-bottom: 10px; 
                }
                .store-name { 
                    font-size: 16px; 
                    font-weight: bold; 
                    margin-bottom: 4px; 
                }
                .order-number { 
                    font-size: 16px; 
                    font-weight: bold; 
                    margin: 8px 0;
                    padding: 4px;
                    background: #000;
                    color: #fff;
                }
                .order-date { 
                    font-size: 11px; 
                    margin-top: 4px; 
                }
                .separator { 
                    border-top: 1px dashed #000;
                    margin: 8px 0;
                }
                .separator-thin { 
                    border-top: 1px dotted #555;
                    margin: 6px 0;
                }
                .section { 
                    margin-bottom: 10px; 
                }
                .title { 
                    font-weight: bold; 
                    font-size: 13px;
                    text-transform: uppercase; 
                    text-align: center;
                    margin-bottom: 8px; 
                    padding-bottom: 3px;
                    border-bottom: 1px solid #555;
                }
                .info-line { 
                    display: flex;
                    align-items: baseline;
                    margin-bottom: 4px;
                    width: 100%;
                    gap: 4px;
                }
                .info-line .label { 
                    font-weight: bold;
                    flex-shrink: 0;
                }
                .info-line .value { 
                    text-align: left;
                    flex-grow: 1;
                    word-wrap: break-word;
                }
                .info-line.full-width {
                    display: block;
                    margin-bottom: 5px;
                }
                .info-line.full-width .label {
                    display: inline-block;
                    font-weight: bold;
                    margin-right: 4px;
                }
                .info-line.full-width .value {
                    display: inline-block;
                    text-align: left;
                }                
                .info-line.address {
                    display: flex;
                    flex-direction: column; /* Empilha o label e o valor */
                }
                .info-line.address .value {
                    text-align: left;
                    padding-left: 8px; /* Adiciona um recuo para alinhar o endereço */
                    white-space: pre-line; /* Respeita as quebras de linha <br> */
                }
                .items-container {
                    margin-top: 8px;
                }
                .item { 
                    margin-bottom: 6px; 
                    padding-bottom: 4px;
                    border-bottom: 1px dotted #999;
                }
                .item:last-child {
                    border-bottom: none;
                }
                .item-info { 
                    display: flex; 
                    justify-content: space-between;
                    margin-bottom: 2px;
                    gap: 8px;
                }
                .item-name {
                    flex: 1;
                    word-wrap: break-word;
                    font-weight: bold;
                }
                .item-qty {
                    font-weight: bold;
                    margin-right: 4px;
                }
                .item-info .price { 
                    font-weight: bold; 
                    white-space: nowrap;
                    min-width: 70px;
                    text-align: right;
                }
                .item-details { 
                    font-size: 11px; 
                    padding-left: 15px; 
                    color: #444; 
                    line-height: 1.4;
                    white-space: pre-line;
                }
                .item-details.obs { 
                    color: #000;
                    font-weight: bold;
                    font-style: italic; 
                    background: #f0f0f0;
                    padding: 3px 6px;
                    margin-top: 4px;
                    border-left: 2px solid #555;
                }
                .observations {
                    margin-top: 10px;
                }
                .obs-content {
                    font-size: 11px;
                    font-style: italic;
                    padding: 5px;
                    background: #f0f0f0;
                    line-height: 1.4;
                }
                .totals {
                    margin-top: 10px;
                }
                .total-line { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 4px 0;
                    font-size: 11px;
                }
                .total-line.payment {
                    
                }
                .total-line.change-info {
                    font-size: 11px;
                    margin: 2px 0;
                    padding: 2px 0;
                }
                .total-line.grand-total { 
                    font-size: 18px; 
                    font-weight: bold; 
                    margin-top: 6px;
                }
                .total-line .label {
                    text-transform: uppercase;
                }
                .total-line .value {
                    font-weight: bold;
                }
                .footer { 
                    text-align: center; 
                    margin-top: 15px; 
                    font-size: 11px;
                    padding-top: 10px;
                    border-top: 1px dashed #000;
                }
                .footer div {
                    margin: 3px 0;
                }
            `;
            tempElement.prepend(style);
            document.body.appendChild(tempElement);
            
            // Aguarda um momento para o DOM renderizar
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Calcula a altura necessária baseada no conteúdo
            const contentHeight = tempElement.offsetHeight;
            const heightInMm = Math.ceil((contentHeight * 0.264583) + 20); // Converte px para mm e adiciona margem
            
            console.log(`[PDF] Altura calculada: ${contentHeight}px = ${heightInMm}mm`);
            
            // Remove o elemento temporário
            document.body.removeChild(tempElement);
            
            // Cria o elemento final para o PDF (sem adicionar ao DOM)
            const element = document.createElement('div');
            element.innerHTML = content;
            const finalStyle = document.createElement('style');
            finalStyle.innerHTML = style.innerHTML;
            element.prepend(finalStyle);

            const options = {
                margin: [5, 5, 5, 5],
                filename: `pedido-${order.order_id}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: [80, Math.max(heightInMm, 100)], // Mínimo de 100mm
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            try {
                const pdfBlob = await html2pdf().from(element).set(options).output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);

                const printWindow = window.open(pdfUrl, '_blank');
                if (printWindow) {
                    printWindow.onload = function() {
                        printWindow.print();
                    };
                    showToast('PDF gerado com sucesso!', 'success', 3000);
                } else {
                    showToast('Por favor, habilite pop-ups para visualizar o PDF.', 'warning', 5000);
                }
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showToast('Erro ao gerar PDF. Tente novamente.', 'error', 5000);
            } finally {
                button.textContent = 'Imprimir Pedido';
                button.disabled = false;
            }
        }

        /**
         * Formata um número como moeda (BRL).
         * @param {number} value - O valor a ser formatado.
         * @returns {string} - O valor formatado como R$.
         */
        function formatCurrency(value) {
            if (typeof value !== 'number') {
                value = parseFloat(value) || 0;
            }
            return value.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        /**
         * Atualiza o dashboard de vendas com os dados dos pedidos.
         * @param {Array<Object>} orders - A lista completa de pedidos.
         */
        function updateDashboard(orders) {
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let salesToday = 0;
            let salesMonth = 0;

            orders.forEach(order => {
                try {
                    const orderDate = new Date(order.created_at);
                    const orderTotal = parseFloat(String(order.total).replace(/[^0-9,]/g, '').replace(',', '.')) || 0;

                    if (isNaN(orderDate.getTime())) return; // Pula se a data for inválida

                    // Verifica se o pedido é do mês e ano correntes
                    if (orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear) {
                        if (order.status !== 'Cancelado') salesMonth += orderTotal;

                        // Verifica se o pedido também é do dia corrente
                        if (orderDate.getDate() === currentDay) {
                            if (order.status !== 'Cancelado') salesToday += orderTotal;
                        }
                    }
                } catch (e) {
                    // Ignora erros de parsing de um pedido específico
                }
            });

            const salesTodayEl = document.getElementById('sales-today');
            const salesMonthEl = document.getElementById('sales-month');

            if (salesTodayEl) salesTodayEl.textContent = formatCurrency(salesToday);
            if (salesMonthEl) salesMonthEl.textContent = formatCurrency(salesMonth);
        }

        function deactivatePresetButtons() {
            document.querySelectorAll('.finance-filter-btn[data-period]').forEach(btn => {
                if(btn.dataset.period !== 'custom')
                    btn.classList.remove('active');
            });
        }
        
        /**
         * Limpa os filtros de data e volta para "Hoje"
         */
        function clearDateFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            filterSales('today');
            showToast('Filtros limpos. Exibindo dados de hoje.', 'info', 3000);
        }

        /**
         * Formata a chave do método de pagamento para um texto amigável com emoji.
         * @param {string} methodKey - A chave do método de pagamento (ex: 'cartao-credito').
         * @returns {string} - O nome formatado (ex: '💳 Cartão de Crédito').
         */
        function formatPaymentMethod(methodKey) {
            if (!methodKey) return 'Não informado';

            const paymentMap = {
                'dinheiro': '💵 Dinheiro',
                'pix': '📱 Pix',
                'cartao-credito': '💳 Cartão de Crédito',
                'cartao-debito': '💳 Cartão de Débito'
            };

            return paymentMap[methodKey] || methodKey
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }


        /**
         * Filtra e exibe os dados de vendas para um período específico.
         * @param {string} period - O período a ser filtrado ('today', 'yesterday', 'last7days', 'this_month').
         */
        async function filterSales(period) {
            console.log(`[Financeiro] Filtrando vendas para o período: ${period}`);

            // Atualiza o botão ativo
            document.querySelectorAll('.finance-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            if (period !== 'custom') {
                // Limpa os campos de data customizada se um preset for clicado
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
            }

            let startDate, endDate;

            const periodHandlers = {
                today: () => {
                    const now = new Date();
                    return [new Date(now.setHours(0, 0, 0, 0)), new Date(now.setHours(23, 59, 59, 999))];
                },
                yesterday: () => {
                    const now = new Date();
                    const yesterday = new Date(now.setDate(now.getDate() - 1));
                    return [new Date(yesterday.setHours(0, 0, 0, 0)), new Date(yesterday.setHours(23, 59, 59, 999))];
                },
                last7days: () => {
                    const now = new Date();
                    return [new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6, 0, 0, 0), new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59)];
                },
                last30days: () => {
                    const now = new Date();
                    return [new Date(now.getFullYear(), now.getMonth(), now.getDate() - 29, 0, 0, 0), new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59)];
                },
                this_week: () => {
                    const now = new Date();
                    const dayOfWeek = now.getDay(); // 0 = Domingo
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - dayOfWeek); // Volta para domingo
                    startOfWeek.setHours(0, 0, 0, 0);
                    const endOfWeek = new Date(now);
                    endOfWeek.setHours(23, 59, 59, 999);
                    return [startOfWeek, endOfWeek];
                },
                last_week: () => {
                    const now = new Date();
                    const dayOfWeek = now.getDay();
                    const startOfLastWeek = new Date(now);
                    startOfLastWeek.setDate(now.getDate() - dayOfWeek - 7);
                    startOfLastWeek.setHours(0, 0, 0, 0);
                    const endOfLastWeek = new Date(startOfLastWeek);
                    endOfLastWeek.setDate(startOfLastWeek.getDate() + 6);
                    endOfLastWeek.setHours(23, 59, 59, 999);
                    return [startOfLastWeek, endOfLastWeek];
                },
                this_month: () => {
                    const now = new Date();
                    return [new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0), new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59)];
                },
                last_month: () => {
                    const now = new Date();
                    const lastMonth = now.getMonth() - 1;
                    const year = lastMonth < 0 ? now.getFullYear() - 1 : now.getFullYear();
                    const month = lastMonth < 0 ? 11 : lastMonth;
                    return [new Date(year, month, 1, 0, 0, 0), new Date(year, month + 1, 0, 23, 59, 59)];
                },
                this_year: () => {
                    const now = new Date();
                    return [new Date(now.getFullYear(), 0, 1, 0, 0, 0), new Date(now.getFullYear(), 11, 31, 23, 59, 59)];
                },
                custom: () => {
                    const startValue = document.getElementById('start-date').value;
                    const endValue = document.getElementById('end-date').value;
                    if (!startValue || !endValue) {
                        showToast('Por favor, selecione a data de início e de fim.', 'warning');
                        return [null, null];
                    }
                    let startDate = new Date(startValue);
                    startDate.setHours(0, 0, 0, 0);
                    let endDate = new Date(endValue);
                    endDate.setHours(23, 59, 59, 999);
                    
                    if (startDate > endDate) {
                        showToast('A data inicial não pode ser maior que a data final.', 'error');
                        return [null, null];
                    }
                    
                    deactivatePresetButtons();
                    return [startDate, endDate];
                }
            };

            const handler = periodHandlers[period];
            if (handler) {
                [startDate, endDate] = handler();
            }

            if (!startDate || !endDate) return; // Para a execução se as datas forem inválidas
            
            console.log(`[Financeiro] Período de busca: ${startDate.toISOString()} a ${endDate.toISOString()}`);

            try {
                const { data: orders, error } = await supabase
                    .from('pedidos')
                    .select('order_id, customer_name, total, payment_method, created_at, status')
                    .gte('created_at', startDate.toISOString())
                    .lt('created_at', endDate.toISOString())
                    .eq('status', 'Finalizado'); // Considera apenas pedidos finalizados

                if (error) {
                    throw error;
                }

                // Armazena os pedidos filtrados para a função de exportação
                currentFinanceOrders = orders;

                console.log(`[Financeiro] ${orders.length} pedidos finalizados encontrados no período.`);

                const totalSales = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                const totalOrdersCount = orders.length;

                // Processa dados para o gráfico de pizza
                const salesByPayment = orders.reduce((acc, order) => {
                    const method = order.payment_method || 'nao-informado';
                    if (!acc[method]) {
                        acc[method] = 0;
                    }
                    acc[method] += order.total || 0;
                    return acc;
                }, {});

                // Atualiza os cards
                const salesLabel = document.getElementById('sales-period-label');
                const salesTotal = document.getElementById('sales-period-total');
                const ordersLabel = document.getElementById('orders-period-label');
                const ordersCount = document.getElementById('orders-period-count');

                const periodLabels = {
                    'today': 'Vendas de Hoje',
                    'yesterday': 'Vendas de Ontem',
                    'last7days': 'Vendas (Últimos 7 dias)',
                    'last30days': 'Vendas (Últimos 30 dias)',
                    'this_week': 'Vendas (Esta Semana)',
                    'last_week': 'Vendas (Semana Passada)',
                    'this_month': 'Vendas (Este Mês)',
                    'last_month': 'Vendas (Mês Passado)',
                    'this_year': 'Vendas (Este Ano)',
                    'custom': 'Vendas no Período'
                };
                
                // Atualiza informação do período no topo
                const periodInfo = document.getElementById('period-info');
                if (periodInfo) {
                    const startStr = startDate.toLocaleDateString('pt-BR');
                    const endStr = endDate.toLocaleDateString('pt-BR');
                    periodInfo.textContent = `${startStr} - ${endStr}`;
                }

                if (salesLabel) salesLabel.textContent = periodLabels[period] || 'Vendas no Período';
                if (salesTotal) salesTotal.textContent = formatCurrency(totalSales);
                if (ordersLabel) ordersLabel.textContent = 'Pedidos no Período';
                if (ordersCount) ordersCount.textContent = totalOrdersCount;

                // Calcula e atualiza métricas adicionais
                const averageTicket = totalOrdersCount > 0 ? totalSales / totalOrdersCount : 0;
                const uniqueCustomers = new Set(orders.map(o => o.customer_name)).size;
                
                document.getElementById('average-ticket').textContent = formatCurrency(averageTicket);
                document.getElementById('unique-customers').textContent = uniqueCustomers;

                // Renderiza a tabela de detalhes
                renderFinanceTable(orders);

                // Renderiza o gráfico de pizza
                renderPaymentMethodChart(salesByPayment);
                
                // Renderiza análise de clientes (CRM)
                await renderCRMAnalysis(startDate, endDate);

            } catch (err) {
                console.error('[Financeiro] Erro ao buscar dados de vendas:', err);
                showToast('Não foi possível carregar os dados financeiros.', 'error');
            }
        }
        
        /**
         * Renderiza a análise de clientes (CRM)
         */
        async function renderCRMAnalysis(startDate, endDate) {
            try {
                const { data: orders, error } = await supabase
                    .from('pedidos')
                    .select('customer_name, customer_phone, total, created_at')
                    .gte('created_at', startDate.toISOString())
                    .lt('created_at', endDate.toISOString())
                    .eq('status', 'Finalizado');

                if (error) throw error;

                // Agrupa pedidos por cliente
                const customerData = {};
                orders.forEach(order => {
                    const name = order.customer_name || 'Cliente não informado';
                    if (!customerData[name]) {
                        customerData[name] = {
                            name: name,
                            phone: order.customer_phone || 'Não informado',
                            orders: 0,
                            totalSpent: 0,
                            lastOrder: order.created_at
                        };
                    }
                    customerData[name].orders++;
                    customerData[name].totalSpent += order.total || 0;
                    if (new Date(order.created_at) > new Date(customerData[name].lastOrder)) {
                        customerData[name].lastOrder = order.created_at;
                    }
                });

                // Converte para array e ordena por total gasto
                const customersArray = Object.values(customerData)
                    .map(customer => ({
                        ...customer,
                        averageTicket: customer.totalSpent / customer.orders
                    }))
                    .sort((a, b) => b.totalSpent - a.totalSpent)
                    .slice(0, 20); // Top 20 clientes

                // Renderiza a tabela
                const tableBody = document.getElementById('crm-table-body');
                tableBody.innerHTML = '';

                if (customersArray.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                Nenhum cliente encontrado neste período.
                            </td>
                        </tr>
                    `;
                    return;
                }

                customersArray.forEach((customer, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    // Badge de ranking
                    let rankBadge = '';
                    if (index === 0) rankBadge = '🥇';
                    else if (index === 1) rankBadge = '🥈';
                    else if (index === 2) rankBadge = '🥉';
                    else rankBadge = `${index + 1}º`;

                    const phoneFormatted = customer.phone.replace(/\D/g, '');
                    const lastOrderDate = new Date(customer.lastOrder).toLocaleDateString('pt-BR');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${rankBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${customer.phone}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full font-semibold">${customer.orders}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-700">${formatCurrency(customer.totalSpent)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatCurrency(customer.averageTicket)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${lastOrderDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="openWhatsApp('https://wa.me/${phoneFormatted}?text=${encodeURIComponent(`Olá ${customer.name}! 👋`)}')" 
                               class="text-green-600 hover:text-green-800 font-medium flex items-center gap-1 cursor-pointer bg-transparent border-none"
                               title="Enviar mensagem no WhatsApp">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/></svg>
                                WhatsApp
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Armazena dados para exportação
                window.currentCRMData = customersArray;

            } catch (err) {
                console.error('[CRM] Erro ao buscar dados de clientes:', err);
            }
        }
        
        /**
         * Exporta dados de clientes para CSV
         */
        function exportCustomersToCSV() {
            if (!window.currentCRMData || window.currentCRMData.length === 0) {
                showToast('Nenhum dado de cliente para exportar.', 'warning');
                return;
            }

            const headers = [
                "Ranking",
                "Nome do Cliente",
                "Telefone",
                "Total de Pedidos",
                "Total Gasto",
                "Ticket Médio",
                "Último Pedido"
            ];

            const csvRows = [
                headers.join(';'),
                ...window.currentCRMData.map((customer, index) => {
                    const row = [
                        index + 1,
                        `"${customer.name.replace(/"/g, '""')}"`,
                        customer.phone,
                        customer.orders,
                        String(customer.totalSpent.toFixed(2)).replace('.', ','),
                        String(customer.averageTicket.toFixed(2)).replace('.', ','),
                        new Date(customer.lastOrder).toLocaleDateString('pt-BR')
                    ];
                    return row.join(';');
                })
            ];

            const csvContent = "data:text/csv;charset=utf-8," + '\uFEFF' + csvRows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);

            const today = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            link.setAttribute("download", `clientes-top-${today}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Lista de clientes exportada com sucesso!', 'success');
        }

        /**
         * Renderiza o gráfico de pizza com as vendas por forma de pagamento.
         * @param {Object} salesData - Objeto com vendas agrupadas por método de pagamento.
         */
        function renderPaymentMethodChart(salesData) {
            const ctx = document.getElementById('payment-chart').getContext('2d');

            // Destrói o gráfico anterior se ele existir
            if (paymentChart) {
                paymentChart.destroy();
            }

            const labels = Object.keys(salesData).map(method => formatPaymentMethod(method));
            const data = Object.values(salesData);

            paymentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.length > 0 ? labels : ['Nenhum dado'],
                    datasets: [{
                        label: 'Vendas por Pagamento',
                        data: data,
                        backgroundColor: [
                            '#10b981', // Verde
                            '#3b82f6', // Azul
                            '#f59e0b', // Amarelo
                            '#8b5cf6', // Roxo
                            '#ec4899', // Rosa
                            '#6b7280'  // Cinza
                        ],
                        borderColor: data.length > 0 ? '#ffffff' : 'transparent',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: { callbacks: { label: (context) => `${context.label}: ${formatCurrency(context.raw)}` } }
                    }
                }
            });
        }

        /**
         * Renderiza a tabela de detalhes financeiros com os pedidos do período.
         * @param {Array<Object>} orders - A lista de pedidos a ser exibida.
         */
        function renderFinanceTable(orders) {
            const tableBody = document.getElementById('finance-table-body');
            const totalOrdersEl = document.getElementById('finance-total-orders');
            const totalValueEl = document.getElementById('finance-total-value');

            if (!tableBody) return;

            tableBody.innerHTML = ''; // Limpa a tabela

            if (orders.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-6 text-center text-gray-500">Nenhum pedido finalizado neste período.</td>
                    </tr>
                `;
                if (totalOrdersEl) totalOrdersEl.textContent = '0';
                if (totalValueEl) totalValueEl.textContent = formatCurrency(0);
                return;
            }

            // Calcula e atualiza os totais no rodapé
            const totalOrdersCount = orders.length;
            const totalOrderValue = orders.reduce((sum, order) => sum + (order.total || 0), 0);

            if (totalOrdersEl) totalOrdersEl.textContent = totalOrdersCount;
            if (totalValueEl) totalValueEl.textContent = formatCurrency(totalOrderValue);

            // Ordena os pedidos do mais recente para o mais antigo
            const sortedOrders = [...orders].sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });

            sortedOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-600">${order.order_id}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${order.customer_name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-700">${formatCurrency(order.total)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">${formatPaymentMethod(order.payment_method)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${new Date(order.created_at).toLocaleString('pt-BR')}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- INÍCIO: Lógica para Exportar CSV ---

        let currentFinanceOrders = []; // Armazena os pedidos filtrados para exportação

        /**
         * Exporta os dados financeiros atualmente exibidos para um arquivo CSV.
         */
        function exportFinanceToCSV() {
            if (currentFinanceOrders.length === 0) {
                showToast('Não há dados para exportar. Filtre um período primeiro.', 'warning');
                return;
            }

            const headers = [
                "ID Pedido",
                "Cliente",
                "Valor Total",
                "Forma de Pagamento",
                "Data do Pedido"
            ];

            // Converte os dados para o formato CSV
            const csvRows = [
                headers.join(';'), // Usa ponto e vírgula para compatibilidade com Excel em português
                ...currentFinanceOrders.map(order => {
                    const row = [
                        order.order_id,
                        `"${order.customer_name.replace(/"/g, '""')}"`, // Trata aspas no nome
                        String(order.total).replace('.', ','), // Formato de moeda para CSV
                        formatPaymentMethod(order.payment_method),
                        new Date(order.created_at).toLocaleString('pt-BR')
                    ];
                    return row.join(';');
                })
            ];

            const csvContent = "data:text/csv;charset=utf-8," + '\uFEFF' + csvRows.join('\n');
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);

            const today = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            link.setAttribute("download", `relatorio-financeiro-${today}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Relatório exportado com sucesso!', 'success');
        }

        /**
         * ===================================================================
         * FUNÇÕES DO PAINEL DE DESEMPENHO
         * ===================================================================
         */

        async function updatePerformanceDashboard() {
            console.log('[Desempenho] Atualizando dashboard...');

            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
            const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toISOString();

            try {
                const { data: orders, error } = await supabase
                    .from('pedidos')
                    .select('created_at, status, updated_at')
                    .gte('created_at', startOfDay)
                    .lt('created_at', endOfDay);

                if (error) throw error;

                console.log(`[Desempenho] ${orders.length} pedidos encontrados para hoje.`);

                // 1. Calcular tempo médio de preparo
                const completedOrders = orders.filter(o => o.status === 'Finalizado');
                let totalPrepTime = 0;
                completedOrders.forEach(order => {
                    const startTime = new Date(order.created_at);
                    const endTime = new Date(order.updated_at);
                    totalPrepTime += (endTime - startTime);
                });
                const avgPrepTime = completedOrders.length > 0 ? totalPrepTime / completedOrders.length : 0;
                const avgMinutes = Math.floor(avgPrepTime / 60000);
                const avgSeconds = Math.floor((avgPrepTime % 60000) / 1000);
                document.getElementById('avg-prep-time').textContent = `${String(avgMinutes).padStart(2, '0')}:${String(avgSeconds).padStart(2, '0')}`;

                // 2. Total de pedidos hoje
                document.getElementById('total-orders-today').textContent = orders.length;

                // 3. Calcular pedidos por hora e horário de pico
                const ordersByHour = Array(24).fill(0);
                orders.forEach(order => {
                    const hour = new Date(order.created_at).getHours();
                    ordersByHour[hour]++;
                });

                let peakHour = -1;
                let maxOrders = 0;
                ordersByHour.forEach((count, hour) => {
                    if (count > maxOrders) {
                        maxOrders = count;
                        peakHour = hour;
                    }
                });
                document.getElementById('peak-hour').textContent = peakHour !== -1 ? `${String(peakHour).padStart(2, '0')}:00` : '--:--';

                // 4. Renderizar gráfico de pedidos por hora
                renderOrdersByHourChart(ordersByHour);

            } catch (err) {
                console.error('[Desempenho] Erro ao buscar dados:', err);
                alert('Não foi possível carregar os dados de desempenho.');
            }
        }

        function renderOrdersByHourChart(data) {
            const ctx = document.getElementById('orders-by-hour-chart').getContext('2d');
            if (ordersByHourChart) {
                ordersByHourChart.destroy();
            }

            ordersByHourChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Nº de Pedidos',
                        data: data,
                        backgroundColor: 'rgba(96, 165, 250, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Atualização dos contadores com debounce para melhor performance
        function updateColumnCounts() {
            // Cancela a atualização anterior se ainda não foi executada
            if (updateCountersTimeout) {
                clearTimeout(updateCountersTimeout);
            }
            
            // Agenda a atualização para daqui a 100ms
            updateCountersTimeout = setTimeout(() => {
                if (!domCache.initialized) initDOMCache();
                
                const columns = [
                    { id: 'column-novo', counterId: 'count-novo' },
                    { id: 'column-em-preparo', counterId: 'count-em-preparo' },
                    { id: 'column-finalizado', counterId: 'count-finalizado' },
                    { id: 'column-cancelado', counterId: 'count-cancelado' }
                ];

                columns.forEach(col => {
                    const columnEl = domCache.columns[col.id] || document.getElementById(col.id);
                    const counterEl = domCache.counters[col.counterId] || document.getElementById(col.counterId);
                    
                    if (columnEl && counterEl) {
                        // Conta apenas os cards visíveis
                        const visibleCards = Array.from(columnEl.children).filter(
                            card => card.style.display !== 'none'
                        ).length;
                        
                        // Só atualiza se o valor mudou (evita reflow desnecessário)
                        if (counterEl.textContent !== String(visibleCards)) {
                            counterEl.textContent = visibleCards;
                            
                            // Adiciona animação sutil no contador
                            counterEl.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                counterEl.style.transform = 'scale(1)';
                            }, 150);
                        }
                    }
                });
                
                // Atualiza também os botões de toggle
                updateToggleButtons();
                
                updateCountersTimeout = null;
            }, 100);
        }

        function applyFilter() {
            const searchQuery = document.getElementById('search-orders').value.toLowerCase().trim();
            const cards = document.querySelectorAll('.order-card');

            cards.forEach(card => {
                const orderType = card.dataset.type;
                const orderData = JSON.parse(card.dataset.order);
                const orderId = orderData.order_id.toLowerCase();
                const customerName = (orderData.customer_name || '').toLowerCase();

                const matchesFilter = currentFilter === 'all' || currentFilter === orderType;
                const matchesSearch = searchQuery === '' || orderId.includes(searchQuery) || customerName.includes(searchQuery);

                if (matchesFilter && matchesSearch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });

            // Atualiza as contagens após aplicar o filtro e a busca
            updateColumnCounts();
        }

        function setupFilters() {
            const filterButtons = document.querySelectorAll('#order-filters .filter-btn');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove a classe 'active' de todos os botões
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    // Adiciona a classe 'active' ao botão clicado
                    button.classList.add('active');

                    // Define o filtro atual e aplica
                    currentFilter = button.dataset.filter;
                    console.log(`[Filtro] Aplicando filtro: ${currentFilter}`);
                    applyFilter();
                });
            });

            // Configura os filtros mobile também
            const mobileFilterButtons = document.querySelectorAll('#order-filters-mobile .filter-btn');
            mobileFilterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    mobileFilterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    currentFilter = button.dataset.filter;
                    console.log(`[Filtro Mobile] Aplicando filtro: ${currentFilter}`);
                    applyFilter();
                });
            });
        }

        function initializeKanban() {
            const columns = ['column-novo', 'column-em-preparo', 'column-finalizado'];
            columns.forEach(columnId => {
                const columnEl = document.getElementById(columnId);
                if (columnEl) {
                    new Sortable(columnEl, {
                        group: 'kanban', // Permite mover entre colunas com o mesmo grupo
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        filter: '.not-draggable', // Ignora cards com esta classe
                        onEnd: function (evt) {
                            const itemEl = evt.item; // O card que foi movido
                            const toColumn = evt.to;   // A coluna de destino

                            const orderId = itemEl.id.replace('order-', '');
                            let newStatus = '';

                            if (toColumn.id === 'column-novo') {
                                newStatus = 'Novo';
                            } else if (toColumn.id === 'column-em-preparo') {
                                newStatus = 'Em Preparo';
                            } else if (toColumn.id === 'column-finalizado') {
                                newStatus = 'Finalizado';
                            }

                            // Se o status realmente mudou, chama a função para atualizar
                            if (newStatus && itemEl.dataset.status !== newStatus) {
                                console.log(`Pedido ${orderId} movido para ${newStatus}`);
                                changeStatus(orderId, newStatus);

                                // Adiciona o pedido ao mapa de atualizados recentemente para evitar conflitos
                                recentlyUpdatedOrders.set(orderId, Date.now());
                                setTimeout(() => {
                                    recentlyUpdatedOrders.delete(orderId);
                                }, 10000); // Bloqueia atualizações por 10 segundos
                            }
                        }
                    });
                }
            });
        }

        // Função para carregar os pedidos iniciais do Supabase
        async function fetchInitialOrders() {
            const statusIndicator = document.getElementById('status-indicator');
            statusIndicator.textContent = 'Conectando...';
            statusIndicator.style.color = '#6b7280';

            const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();

            const { data: orders, error } = await supabase
                .from('pedidos')
                .select('*')
                // Busca pedidos ativos OU pedidos finalizados/cancelados nas últimas 24h
                .or(`status.in.("Novo","Em Preparo"),and(status.in.("Finalizado","Cancelado"),created_at.gte.${twentyFourHoursAgo})`)
                .order('created_at', { ascending: false }); // Pedidos mais novos primeiro

            if (error) {
                console.error('Erro ao buscar pedidos iniciais:', error);
                statusIndicator.textContent = 'Erro de conexão!';
                statusIndicator.style.color = '#ef4444';
                return;
            }

            console.log(`[Conexão] ${orders.length} pedidos ativos carregados.`);
            orders.forEach(order => {
                const card = renderOrderCard(order);
                if (card) {
                    const targetColumn = getColumnForStatus(order.status);
                    if (targetColumn) targetColumn.append(card);
                }
            });
            updateColumnCounts();
            updateDashboard(orders);
            statusIndicator.textContent = 'Conectado em tempo real';
            statusIndicator.style.color = '#10b981';
        }

        // Função para ouvir as mudanças em tempo real
        function subscribeToChanges() {
            const channel = supabase.channel('pedidos-changes');

            channel
                .on('postgres_changes', { event: '*', schema: 'public', table: 'pedidos' }, payload => {
                    console.log('[Real-Time] Mudança recebida:', payload);

                    if (payload.eventType === 'INSERT') {
                        const newOrder = payload.new;
                        const card = renderOrderCard(newOrder);
                        if (card) {
                            const targetColumn = getColumnForStatus(newOrder.status);
                            if (targetColumn) targetColumn.prepend(card);
                            if (soundEnabled) newOrderSound.play().catch(e => console.log("Autoplay bloqueado."));
                        }
                    } else if (payload.eventType === 'UPDATE') {
                        const updatedOrder = payload.new;
                        const card = document.getElementById(`order-${updatedOrder.id}`);
                        
                        if (card) {
                            const oldStatus = card.dataset.status;
                            if (oldStatus !== updatedOrder.status) {
                                console.log(`[Real-Time] Status do pedido #${updatedOrder.order_id} mudou de '${oldStatus}' para '${updatedOrder.status}'. Movendo card.`);
                                
                                // Atualiza o dataset antes de mover
                                card.dataset.status = updatedOrder.status;
                                card.dataset.order = JSON.stringify(updatedOrder);
                                
                                // Animação de saída suave
                                card.style.transition = 'all 0.3s ease-out';
                                card.style.opacity = '0';
                                card.style.transform = 'translateX(-20px)';
                                
                                setTimeout(() => {
                                    // Remove o card da coluna atual
                                    card.remove();
                                    
                                    // Renderiza o novo card com o status atualizado
                                    const newCard = renderOrderCard(updatedOrder);
                                    if (newCard) {
                                        const targetColumn = getColumnForStatus(updatedOrder.status);
                                        if (targetColumn) {
                                            // Se o pedido foi cancelado, mostrar um toast
                                            if (updatedOrder.status === 'Cancelado') {
                                                showToast(`Pedido #${updatedOrder.order_id} foi cancelado pelo cliente!`, 'warning', 10000);
                                                if (soundEnabled) canceledOrderSound.play().catch(e => console.log("Autoplay do som de cancelamento bloqueado."));
                                            }
                                            
                                            // Adiciona com animação de entrada
                                            newCard.style.opacity = '0';
                                            newCard.style.transform = 'translateX(20px)';
                                            targetColumn.prepend(newCard);
                                            
                                            // Trigger reflow
                                            newCard.offsetHeight;
                                            
                                            // Anima entrada
                                            requestAnimationFrame(() => {
                                                newCard.style.transition = 'all 0.3s ease-in';
                                                newCard.style.opacity = '1';
                                                newCard.style.transform = 'translateX(0)';
                                            });
                                        }
                                    }
                                    
                                    // Atualiza contadores após a animação
                                    updateColumnCounts();
                                }, 300);
                            } else {
                                // Se apenas os dados mudaram (não o status), atualiza o card in-place
                                console.log(`[Real-Time] Dados do pedido #${updatedOrder.order_id} atualizados sem mudança de status.`);
                                updateCardContent(card, updatedOrder);
                            }
                        }
                    }
                    updateColumnCounts();
                })
                .subscribe();
            
            console.log('[Real-Time] Assinatura de mudanças na tabela "pedidos" ativada.');
        }

        /**
         * Verifica periodicamente os pedidos na coluna "Novos" para destacar os que estão atrasados.
         */
        function checkOverdueOrders() {
            const OVERDUE_THRESHOLD = 10 * 60 * 1000; // 10 minutos em milissegundos
            console.log('[Timer] Verificando pedidos atrasados...');
            const newOrdersColumn = document.getElementById('column-novo');
            if (!newOrdersColumn) return;

            const orderCards = newOrdersColumn.querySelectorAll('.order-card');
            const now = new Date();

            orderCards.forEach(card => {
                try {
                    const orderData = JSON.parse(card.dataset.order);
                    const createdAt = new Date(orderData.created_at);
                    const age = now - createdAt;

                    // Adiciona ou remove a classe 'overdue-order' com base no tempo
                    card.classList.toggle('overdue-order', age > OVERDUE_THRESHOLD);
                } catch (e) {
                    console.error('Erro ao verificar pedido atrasado:', card.id, e);
                }
            });
        }

        // Iniciar
        document.addEventListener('DOMContentLoaded', () => {
            const soundToggle = document.getElementById('sound-toggle');
            soundToggle.addEventListener('change', (e) => {
                soundEnabled = e.target.checked;
            });

            // Inicializa o cache de elementos DOM
            initDOMCache();

            // Aplica as cores e a responsividade
            applyMenuColors();
            setupResponsiveSidebar();

            // Inicializa a funcionalidade de arrastar e soltar
            initializeKanban();

            // Configura os botões de filtro
            setupFilters();

            // Carrega os pedidos iniciais e se inscreve para atualizações em tempo real
            fetchInitialOrders();
            subscribeToChanges();

            // Inicia a verificação de pedidos atrasados a cada minuto
            setInterval(checkOverdueOrders, 60000);
            setTimeout(checkOverdueOrders, 2000); // Roda uma vez logo após o carregamento inicial para garantir a verificação

            // Listener para sair da tela cheia com a tecla ESC
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    if (document.body.classList.contains('fullscreen-mode')) toggleFullScreen();
                }
            });
        });

        // ====================================================================
        // DADOS DO ERP
        // ====================================================================
        // (erpData já foi declarado no início do script)

        // Função para fazer parse correto do CSV (mesma do index.html)
        function parseCSV(csvText) {
            if (!csvText || csvText.trim().length === 0) return [];
            
            csvText = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < csvText.length) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i += 2;
                        continue;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    if (currentRow.some(field => field.length > 0)) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else {
                    currentField += char;
                }
                
                i++;
            }
            
            if (currentField.length > 0 || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(field => field.length > 0)) {
                    rows.push(currentRow);
                }
            }
            
            if (rows.length === 0) return [];
            
            const headers = rows[0].map(header => {
                let cleanHeader = header.replace(/^"|"$/g, '').trim();
                return cleanHeader;
            });
            
            const data = [];
            for (let rowIndex = 1; rowIndex < rows.length; rowIndex++) {
                const row = {};
                const values = rows[rowIndex];
                
                headers.forEach((header, colIndex) => {
                    let value = values[colIndex] || '';
                    
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    
                    value = value.replace(/""/g, '"');
                    
                    row[header] = value;
                });
                
                data.push(row);
            }
            
            return data;
        }

        // ====================================================================
        // ITENS DO CARDÁPIO (Carregados via Google Sheets API)
        // ====================================================================
        // As funções de carregamento estão no erp-integration.js

        // Função para gerar placeholder seguro
        function getPlaceholderImage() {
            const svg = '<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><rect width="50" height="50" fill="#ddd"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="14" fill="#999">?</text></svg>';
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }

        function renderItemsTable() {
            const tbody = document.getElementById('items-table-body');
            if (!tbody) return;
            
            const placeholderImage = getPlaceholderImage();
            
            tbody.innerHTML = erpData.items.map(item => {
                const imgSrc = item.image || placeholderImage;
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <img src="${imgSrc}" alt="${item.name}" class="w-12 h-12 object-cover rounded" onerror="this.src='${placeholderImage}'">
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 text-gray-600">${item.category}</td>
                    <td class="px-6 py-4 text-gray-900 font-semibold">${item.price}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${item.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${item.status === 'active' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-800 mr-3">Editar</button>
                        <button onclick="toggleItemStatus(${item.id})" class="text-yellow-600 hover:text-yellow-800 mr-3">
                            ${item.status === 'active' ? 'Desativar' : 'Ativar'}
                        </button>
                        <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800">Excluir</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function filterItems() {
            const search = document.getElementById('item-search')?.value.toLowerCase() || '';
            const category = document.getElementById('item-category-filter')?.value || '';
            const status = document.getElementById('item-status-filter')?.value || '';
            
            const filtered = erpData.items.filter(item => {
                const matchSearch = item.name.toLowerCase().includes(search) || (item.description || '').toLowerCase().includes(search);
                const matchCategory = !category || item.category === category;
                const matchStatus = !status || item.status === status;
                return matchSearch && matchCategory && matchStatus;
            });
            
            const tbody = document.getElementById('items-table-body');
            if (!tbody) return;
            
            const placeholderImage = getPlaceholderImage();
            
            tbody.innerHTML = filtered.map(item => {
                const imgSrc = item.image || placeholderImage;
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <img src="${imgSrc}" alt="${item.name}" class="w-12 h-12 object-cover rounded" onerror="this.src='${placeholderImage}'">
                    </td>
                    <td class="px-6 py-4 font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 text-gray-600">${item.category}</td>
                    <td class="px-6 py-4 text-gray-900 font-semibold">${item.price}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${item.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${item.status === 'active' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-800 mr-3">Editar</button>
                        <button onclick="toggleItemStatus(${item.id})" class="text-yellow-600 hover:text-yellow-800 mr-3">
                            ${item.status === 'active' ? 'Desativar' : 'Ativar'}
                        </button>
                        <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800">Excluir</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function loadCategoryFilter() {
            const select = document.getElementById('item-category-filter');
            if (!select) return;
            
            const categories = [...new Set(erpData.items.map(item => item.category))];
            select.innerHTML = '<option value="">Todas as categorias</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        // Sincronização via Google Sheets API (ver erp-integration.js)

        // Funções do Modal de Itens
        function showAddItemModal() {
            document.getElementById('item-modal-title').textContent = 'Adicionar Item';
            document.getElementById('item-form').reset();
            document.getElementById('item-id').value = '';
            
            // Preencher select de categorias
            const select = document.getElementById('item-category');
            select.innerHTML = '<option value="">Selecione...</option>' +
                erpData.categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            
            document.getElementById('item-modal').style.display = 'flex';
        }

        function editItem(id) {
            const item = erpData.items.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('item-modal-title').textContent = 'Editar Item';
            document.getElementById('item-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-description').value = item.description || '';
            document.getElementById('item-image').value = item.image || '';
            
            // Preencher select de categorias
            const categorySelect = document.getElementById('item-category');
            categorySelect.innerHTML = '<option value="">Selecione...</option>' +
                erpData.categories.map(cat => `<option value="${cat.name}" ${cat.name === item.category ? 'selected' : ''}>${cat.name}</option>`).join('');
            
            document.getElementById('item-modal').style.display = 'flex';
        }

        function closeItemModal() {
            document.getElementById('item-modal').style.display = 'none';
        }

        async function saveItemForm(event) {
            event.preventDefault();
            
            const id = document.getElementById('item-id').value;
            const itemData = {
                name: document.getElementById('item-name').value,
                category: document.getElementById('item-category').value,
                price: document.getElementById('item-price').value,
                description: document.getElementById('item-description').value,
                image: document.getElementById('item-image').value,
                status: 'active'
            };
            
            if (id) {
                // Editar
                const index = erpData.items.findIndex(i => i.id == id);
                if (index !== -1) {
                    erpData.items[index] = { ...erpData.items[index], ...itemData };
                    
                    // Atualizar na planilha
                    if (typeof updateItemInSheet === 'function') {
                        await updateItemInSheet(erpData.items[index]);
                    }
                    
                    showToast('Item atualizado localmente e na planilha!', 'success');
                }
            } else {
                // Adicionar
                const newId = Math.max(...erpData.items.map(i => i.id), 0) + 1;
                const newItem = { id: newId, ...itemData };
                erpData.items.push(newItem);
                
                // Adicionar na planilha
                if (typeof addItemToSheet === 'function') {
                    await addItemToSheet(newItem);
                }
                
                showToast('Item adicionado localmente e na planilha!', 'success');
            }
            
            renderItemsTable();
            loadCategoryFilter();
            closeItemModal();
        }

        async function toggleItemStatus(id) {
            const item = erpData.items.find(i => i.id === id);
            if (item) {
                item.status = item.status === 'active' ? 'inactive' : 'active';
                
                // Atualizar na planilha
                if (typeof updateItemInSheet === 'function') {
                    await updateItemInSheet(item);
                }
                
                renderItemsTable();
                showToast(`Item ${item.status === 'active' ? 'ativado' : 'desativado'} e atualizado na planilha!`, 'success');
            }
        }

        async function deleteItem(id) {
            if (confirm('Tem certeza que deseja excluir este item? Isso irá remover da planilha também!')) {
                // Deletar da planilha primeiro
                if (typeof deleteItemFromSheet === 'function') {
                    await deleteItemFromSheet(id);
                }
                
                // Remover localmente
                erpData.items = erpData.items.filter(i => i.id !== id);
                renderItemsTable();
                loadCategoryFilter();
                showToast('Item excluído localmente e da planilha!', 'success');
            }
        }

        // ====================================================================
        // CATEGORIAS
        // ====================================================================

        async function loadCategories() {
            try {
                showToast('Carregando categorias...', 'info', 2000);
                const response = await fetch(CATEGORIES_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                console.log('Categorias parseadas:', parsedData);
                console.log('Colunas:', parsedData.length > 0 ? Object.keys(parsedData[0]) : []);
                
                // Estrutura real: nome_categoria, icone_categoria, descricao, ordem, status
                erpData.categories = parsedData.map((cat, index) => ({
                    id: index + 1,
                    name: cat.nome_categoria || cat.categoria || '',
                    icon: cat.icone_categoria || cat.icone || '🍕',
                    order: parseInt(cat.ordem) || index + 1,
                    status: cat.status || 'ativo'
                }));
                
                console.log('Categorias carregadas:', erpData.categories.length);
                renderCategoriesGrid();
                showToast(`${erpData.categories.length} categorias carregadas com sucesso!`, 'success');
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                showToast('Erro ao carregar categorias: ' + error.message, 'error');
            }
        }

        function renderCategoriesGrid() {
            const grid = document.getElementById('categories-grid');
            if (!grid) return;
            
            grid.innerHTML = erpData.categories.map(cat => `
                <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl">${cat.icon}</span>
                        <span class="px-2 py-1 text-xs rounded-full ${cat.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${cat.status === 'active' ? 'Ativo' : 'Inativo'}
                        </span>
                    </div>
                    <h4 class="text-lg font-bold text-gray-800 mb-2">${cat.name}</h4>
                    <p class="text-sm text-gray-600 mb-4">Ordem: ${cat.order}</p>
                    <div class="flex gap-2">
                        <button onclick="editCategory(${cat.id})" class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Editar</button>
                        <button onclick="toggleCategoryStatus(${cat.id})" class="flex-1 px-3 py-2 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700">
                            ${cat.status === 'active' ? 'Desativar' : 'Ativar'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function syncCategoriesFromSheet() {
            if (confirm('Sincronizar categorias com a planilha?')) {
                await loadCategories();
            }
        }

        // Funções do Modal de Categorias
        function showAddCategoryModal() {
            document.getElementById('category-modal-title').textContent = 'Adicionar Categoria';
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-order').value = erpData.categories.length + 1;
            document.getElementById('category-modal').style.display = 'flex';
        }

        function editCategory(id) {
            const cat = erpData.categories.find(c => c.id === id);
            if (!cat) return;
            
            document.getElementById('category-modal-title').textContent = 'Editar Categoria';
            document.getElementById('category-id').value = cat.id;
            document.getElementById('category-name').value = cat.name;
            document.getElementById('category-icon').value = cat.icon;
            document.getElementById('category-order').value = cat.order;
            document.getElementById('category-modal').style.display = 'flex';
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
        }

        function saveCategoryForm(event) {
            event.preventDefault();
            
            const id = document.getElementById('category-id').value;
            const catData = {
                name: document.getElementById('category-name').value,
                icon: document.getElementById('category-icon').value,
                order: parseInt(document.getElementById('category-order').value),
                status: 'active'
            };
            
            if (id) {
                // Editar
                const index = erpData.categories.findIndex(c => c.id == id);
                if (index !== -1) {
                    erpData.categories[index] = { ...erpData.categories[index], ...catData };
                    showToast('Categoria atualizada com sucesso!', 'success');
                }
            } else {
                // Adicionar
                const newId = Math.max(...erpData.categories.map(c => c.id), 0) + 1;
                erpData.categories.push({ id: newId, ...catData });
                showToast('Categoria adicionada com sucesso!', 'success');
            }
            
            renderCategoriesGrid();
            closeCategoryModal();
        }

        function toggleCategoryStatus(id) {
            const cat = erpData.categories.find(c => c.id === id);
            if (cat) {
                cat.status = cat.status === 'active' ? 'inactive' : 'active';
                renderCategoriesGrid();
                showToast(`Categoria ${cat.status === 'active' ? 'ativada' : 'desativada'}!`, 'success');
            }
        }

        // ====================================================================
        // HORÁRIOS
        // ====================================================================

        async function loadHours() {
            try {
                showToast('Carregando horários...', 'info', 2000);
                const response = await fetch(HOURS_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                console.log('Horários parseados:', parsedData);
                console.log('Colunas:', parsedData.length > 0 ? Object.keys(parsedData[0]) : []);
                
                // Estrutura real: nome_semana, Periodo 1, Periodo 2, Periodo 3
                erpData.hours = parsedData.map((hour, index) => {
                    const periodo1 = hour['Periodo 1'] || hour.Periodo1 || '';
                    return {
                        id: index + 1,
                        day: hour.nome_semana || hour.dia || '',
                        open: periodo1.split(' - ')[0] || '',
                        close: periodo1.split(' - ')[1] || '',
                        status: 'open'
                    };
                });
                
                console.log('Horários carregados:', erpData.hours.length);
                renderHoursTable();
                showToast(`${erpData.hours.length} horários carregados com sucesso!`, 'success');
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
                showToast('Erro ao carregar horários: ' + error.message, 'error');
            }
        }

        function renderHoursTable() {
            const tbody = document.getElementById('hours-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = erpData.hours.map(hour => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${hour.day}</td>
                    <td class="px-6 py-4 text-gray-600">${hour.open}</td>
                    <td class="px-6 py-4 text-gray-600">${hour.close}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${hour.status === 'open' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${hour.status === 'open' ? 'Aberto' : 'Fechado'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editHour(${hour.id})" class="text-blue-600 hover:text-blue-800 mr-3">Editar</button>
                        <button onclick="toggleHourStatus(${hour.id})" class="text-yellow-600 hover:text-yellow-800">
                            ${hour.status === 'open' ? 'Fechar' : 'Abrir'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function syncHoursFromSheet() {
            if (confirm('Sincronizar horários com a planilha?')) {
                await loadHours();
            }
        }

        // Funções do Modal de Horários
        function editHour(id) {
            const hour = erpData.hours.find(h => h.id === id);
            if (!hour) return;
            
            document.getElementById('hour-id').value = hour.id;
            document.getElementById('hour-day').value = hour.day;
            document.getElementById('hour-open').value = hour.open;
            document.getElementById('hour-close').value = hour.close;
            document.getElementById('hour-modal').style.display = 'flex';
        }

        function closeHourModal() {
            document.getElementById('hour-modal').style.display = 'none';
        }

        function saveHourForm(event) {
            event.preventDefault();
            
            const id = document.getElementById('hour-id').value;
            const index = erpData.hours.findIndex(h => h.id == id);
            
            if (index !== -1) {
                erpData.hours[index].open = document.getElementById('hour-open').value;
                erpData.hours[index].close = document.getElementById('hour-close').value;
                renderHoursTable();
                showToast('Horário atualizado com sucesso!', 'success');
            }
            
            closeHourModal();
        }

        function toggleHourStatus(id) {
            const hour = erpData.hours.find(h => h.id === id);
            if (hour) {
                hour.status = hour.status === 'open' ? 'closed' : 'open';
                renderHoursTable();
                showToast(`${hour.day} agora está ${hour.status === 'open' ? 'aberto' : 'fechado'}!`, 'success');
            }
        }

        // ====================================================================
        // BAIRROS
        // ====================================================================

        async function loadNeighborhoods() {
            try {
                showToast('Carregando bairros...', 'info', 2000);
                const response = await fetch(NEIGHBORHOODS_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                console.log('Bairros parseados:', parsedData);
                console.log('Colunas:', parsedData.length > 0 ? Object.keys(parsedData[0]) : []);
                
                // Estrutura real: nome_bairro, valor_taxa
                erpData.neighborhoods = parsedData.map((n, index) => ({
                    id: index + 1,
                    name: n.nome_bairro || n.bairro || '',
                    fee: n.valor_taxa || n.taxa || '0',
                    time: '30-40 min',
                    status: 'active'
                }));
                
                console.log('Bairros carregados:', erpData.neighborhoods.length);
                renderNeighborhoodsTable();
                showToast(`${erpData.neighborhoods.length} bairros carregados com sucesso!`, 'success');
            } catch (error) {
                console.error('Erro ao carregar bairros:', error);
                showToast('Erro ao carregar bairros: ' + error.message, 'error');
            }
        }

        function renderNeighborhoodsTable() {
            const tbody = document.getElementById('neighborhoods-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = erpData.neighborhoods.map(n => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-medium text-gray-900">${n.name}</td>
                    <td class="px-6 py-4 text-gray-900 font-semibold">R$ ${n.fee}</td>
                    <td class="px-6 py-4 text-gray-600">${n.time}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${n.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${n.status === 'active' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="editNeighborhood(${n.id})" class="text-blue-600 hover:text-blue-800 mr-3">Editar</button>
                        <button onclick="toggleNeighborhoodStatus(${n.id})" class="text-yellow-600 hover:text-yellow-800 mr-3">
                            ${n.status === 'active' ? 'Desativar' : 'Ativar'}
                        </button>
                        <button onclick="deleteNeighborhood(${n.id})" class="text-red-600 hover:text-red-800">Excluir</button>
                    </td>
                </tr>
            `).join('');
        }

        async function syncNeighborhoodsFromSheet() {
            if (confirm('Sincronizar bairros com a planilha?')) {
                await loadNeighborhoods();
            }
        }

        // Funções do Modal de Bairros
        function showAddNeighborhoodModal() {
            document.getElementById('neighborhood-modal-title').textContent = 'Adicionar Bairro';
            document.getElementById('neighborhood-form').reset();
            document.getElementById('neighborhood-id').value = '';
            document.getElementById('neighborhood-modal').style.display = 'flex';
        }

        function editNeighborhood(id) {
            const n = erpData.neighborhoods.find(nb => nb.id === id);
            if (!n) return;
            
            document.getElementById('neighborhood-modal-title').textContent = 'Editar Bairro';
            document.getElementById('neighborhood-id').value = n.id;
            document.getElementById('neighborhood-name').value = n.name;
            document.getElementById('neighborhood-fee').value = n.fee;
            document.getElementById('neighborhood-time').value = n.time;
            document.getElementById('neighborhood-modal').style.display = 'flex';
        }

        function closeNeighborhoodModal() {
            document.getElementById('neighborhood-modal').style.display = 'none';
        }

        function saveNeighborhoodForm(event) {
            event.preventDefault();
            
            const id = document.getElementById('neighborhood-id').value;
            const nData = {
                name: document.getElementById('neighborhood-name').value,
                fee: document.getElementById('neighborhood-fee').value,
                time: document.getElementById('neighborhood-time').value,
                status: 'active'
            };
            
            if (id) {
                // Editar
                const index = erpData.neighborhoods.findIndex(n => n.id == id);
                if (index !== -1) {
                    erpData.neighborhoods[index] = { ...erpData.neighborhoods[index], ...nData };
                    showToast('Bairro atualizado com sucesso!', 'success');
                }
            } else {
                // Adicionar
                const newId = Math.max(...erpData.neighborhoods.map(n => n.id), 0) + 1;
                erpData.neighborhoods.push({ id: newId, ...nData });
                showToast('Bairro adicionado com sucesso!', 'success');
            }
            
            renderNeighborhoodsTable();
            closeNeighborhoodModal();
        }

        function toggleNeighborhoodStatus(id) {
            const n = erpData.neighborhoods.find(nb => nb.id === id);
            if (n) {
                n.status = n.status === 'active' ? 'inactive' : 'active';
                renderNeighborhoodsTable();
                showToast(`Bairro ${n.status === 'active' ? 'ativado' : 'desativado'}!`, 'success');
            }
        }

        function deleteNeighborhood(id) {
            if (confirm('Tem certeza que deseja excluir este bairro?')) {
                erpData.neighborhoods = erpData.neighborhoods.filter(n => n.id !== id);
                renderNeighborhoodsTable();
                showToast('Bairro excluído com sucesso!', 'success');
            }
        }

        // ====================================================================
        // CONFIGURAÇÕES
        // ====================================================================

        async function loadConfig() {
            try {
                showToast('Carregando configurações...', 'info', 2000);
                const response = await fetch(CONFIG_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                console.log('Configurações parseadas:', parsedData);
                
                erpData.config = {};
                parsedData.forEach(row => {
                    const section = row.secao || row.section || '';
                    const key = row.chave || row.key || '';
                    const value = row.valor || row.value || '';
                    
                    if (section && key && value) {
                        if (!erpData.config[section]) erpData.config[section] = {};
                        erpData.config[section][key] = value;
                    }
                });
                
                console.log('Configurações carregadas:', Object.keys(erpData.config).length, 'seções');
                populateConfigFields();
                showToast('Configurações carregadas com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                showToast('Erro ao carregar configurações: ' + error.message, 'error');
            }
        }

        function populateConfigFields() {
            const config = erpData.config;
            
            // Geral
            if (config.geral) {
                document.getElementById('config-restaurant-name').value = config.geral.nome_estabelecimento || '';
                document.getElementById('config-phone').value = config.geral.telefone || '';
                document.getElementById('config-address').value = config.geral.endereco || '';
                document.getElementById('config-whatsapp').value = config.geral.whatsapp || '';
            }
            
            // Cores
            if (config.cores) {
                document.getElementById('config-color-primary').value = config.cores.cor_primaria || '#D92B2B';
                document.getElementById('config-color-secondary').value = config.cores.cor_secundaria || '#FFC700';
                document.getElementById('config-color-tertiary').value = config.cores.cor_terciaria || '#FDB813';
                document.getElementById('config-color-background').value = config.cores.cor_fundo || '#F9F9F9';
            }
            
            // Entrega
            if (config.entrega) {
                document.getElementById('config-delivery-fee').value = config.entrega.taxa_padrao || '0';
                document.getElementById('config-delivery-time').value = config.entrega.tempo_estimado || '30';
                document.getElementById('config-min-order').value = config.entrega.pedido_minimo || '0';
            }
        }

        async function syncConfigFromSheet() {
            if (confirm('Sincronizar configurações com a planilha?')) {
                await loadConfig();
            }
        }

        function showConfigTab(tabName) {
            // Remove active de todos os botões
            document.querySelectorAll('.config-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Esconde todos os conteúdos
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Ativa o botão clicado
            event.target.classList.add('active', 'border-blue-500', 'text-blue-600');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            
            // Mostra o conteúdo correspondente
            document.getElementById(`config-${tabName}`).classList.remove('hidden');
        }

        function saveConfig(section) {
            showToast(`Configurações de ${section} salvas com sucesso!`, 'success');
            // Aqui você pode adicionar lógica para salvar no Supabase ou atualizar a planilha
        }

        // ====================================================================
        // EXPORTAR DADOS PARA CSV
        // ====================================================================

        function exportToCSV(data, filename, headers) {
            // Criar CSV
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const key = header.toLowerCase();
                    let value = row[key] || '';
                    
                    // Escapar aspas e vírgulas
                    if (value.toString().includes(',') || value.toString().includes('"') || value.toString().includes('\n')) {
                        value = '"' + value.toString().replace(/"/g, '""') + '"';
                    }
                    
                    return value;
                });
                csv += values.join(',') + '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportItems() {
            const headers = ['nome', 'categoria', 'preco', 'descricao', 'imagem'];
            exportToCSV(erpData.items, 'itens_cardapio.csv', headers);
            showToast('Itens exportados com sucesso!', 'success');
        }

        function exportCategories() {
            const headers = ['categoria', 'icone', 'ordem'];
            const data = erpData.categories.map(cat => ({
                categoria: cat.name,
                icone: cat.icon,
                ordem: cat.order
            }));
            exportToCSV(data, 'categorias.csv', headers);
            showToast('Categorias exportadas com sucesso!', 'success');
        }

        function exportHours() {
            const headers = ['dia', 'abertura', 'fechamento'];
            const data = erpData.hours.map(h => ({
                dia: h.day,
                abertura: h.open,
                fechamento: h.close
            }));
            exportToCSV(data, 'horarios.csv', headers);
            showToast('Horários exportados com sucesso!', 'success');
        }

        function exportNeighborhoods() {
            const headers = ['bairro', 'taxa', 'tempo'];
            const data = erpData.neighborhoods.map(n => ({
                bairro: n.name,
                taxa: n.fee,
                tempo: n.time
            }));
            exportToCSV(data, 'bairros.csv', headers);
            showToast('Bairros exportados com sucesso!', 'success');
        }
    </script>
</body>
</html>
